<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>志津川なつかしマップ・デジタル</title>

  <!-- Leaflet.js CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase v9+ compat ビルド -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <style>
    /* ==========================================
       リセット・全体レイアウト
       ========================================== */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
      font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    }

    /* #map と #layer-panel を重ねるためのラッパー */
    #app {
      position: relative;
      width: 100%;
      height: 100%;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* 画像マップ上のカーソル: 地図をつかんで動かす操作感 */
    #map.mode-simple {
      cursor: grab;
    }
    #map.mode-simple:active {
      cursor: grabbing;
    }
    /* Leaflet のマーカー・ポップアップ上ではポインターに戻す */
    #map.mode-simple .leaflet-marker-icon,
    #map.mode-simple .leaflet-popup {
      cursor: pointer;
    }

    /* ズームコントロールのスタイル */
    .leaflet-control-zoom {
      border: none !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
      border-radius: 8px !important;
      overflow: hidden;
    }
    .leaflet-control-zoom a {
      width: 36px !important;
      height: 36px !important;
      line-height: 36px !important;
      font-size: 18px !important;
      color: #333 !important;
      background: #fff !important;
      border-bottom: 1px solid #eee !important;
      transition: background 0.15s;
    }
    .leaflet-control-zoom a:hover {
      background: #f0f0f0 !important;
      color: #000 !important;
    }
    .leaflet-control-zoom a:last-child {
      border-bottom: none !important;
    }

    /* 全体表示ボタン */
    .leaflet-control-fit {
      border: none !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
      border-radius: 8px !important;
      overflow: hidden;
    }
    .leaflet-control-fit a {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: #fff;
      color: #333;
      font-size: 16px;
      text-decoration: none;
      transition: background 0.15s;
    }
    .leaflet-control-fit a:hover {
      background: #f0f0f0;
      color: #000;
    }

    /* ==========================================
       スプラッシュ画面（温かみのあるエモーショナル導入）
       ========================================== */
    #splash {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(160deg, #1a1207 0%, #2d1f0e 25%, #3b2a14 50%, #2a2018 75%, #1c1510 100%);
      color: #fff;
      overflow: hidden;
      transition: opacity 1.6s ease, visibility 1.6s ease;
    }

    #splash.hide {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    /* 背景 — ゆっくり回る温かい光のリング */
    #splash::before,
    #splash::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
    }
    #splash::before {
      width: 500px; height: 500px;
      background: radial-gradient(circle, rgba(232,114,74,0.12) 0%, transparent 70%);
      animation: splash-glow 6s ease-in-out infinite alternate;
    }
    #splash::after {
      width: 800px; height: 800px;
      background: radial-gradient(circle, rgba(255,180,100,0.06) 0%, transparent 70%);
      animation: splash-glow 8s ease-in-out infinite alternate-reverse;
    }

    @keyframes splash-glow {
      0%   { transform: translate(-50%, -50%) scale(0.9); opacity: 0.5; }
      100% { transform: translate(-50%, -50%) scale(1.15); opacity: 1; }
    }

    /* 漂う光の粒（CSS疑似ではなくHTML要素で追加） */
    .splash-particle {
      position: absolute;
      border-radius: 50%;
      background: rgba(255,200,120,0.3);
      filter: blur(1px);
      animation: splash-float linear infinite;
    }
    @keyframes splash-float {
      0%   { transform: translateY(0) scale(1); opacity: 0; }
      15%  { opacity: 1; }
      85%  { opacity: 1; }
      100% { transform: translateY(-100vh) scale(0.5); opacity: 0; }
    }

    /* ----- レイアウト ----- */
    .splash-content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 560px;
      padding: 0 24px;
    }

    /* ロゴマーク */
    #splash .splash-logo {
      width: 52px; height: 52px;
      margin-bottom: 24px;
      opacity: 0;
      transform: scale(0.5);
      animation: splash-pop 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards 0.6s;
      filter: drop-shadow(0 4px 16px rgba(232,114,74,0.4));
    }

    @keyframes splash-pop {
      to { opacity: 1; transform: scale(1); }
    }

    /* タイトル — 一文字ずつ現れるような雰囲気 */
    #splash .splash-title {
      font-size: clamp(22px, 5vw, 40px);
      font-weight: 800;
      letter-spacing: 0.12em;
      line-height: 1.35;
      text-align: center;
      background: linear-gradient(135deg, #fff 0%, #fdd9b5 50%, #f4a460 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      opacity: 0;
      transform: translateY(20px);
      animation: splash-fadein 1.2s ease forwards 1.2s;
    }

    /* サブタイトル */
    #splash .splash-sub {
      margin-top: 14px;
      font-size: clamp(12px, 2.2vw, 16px);
      font-weight: 300;
      letter-spacing: 0.22em;
      color: rgba(255,220,180,0.7);
      opacity: 0;
      transform: translateY(14px);
      animation: splash-fadein 1.2s ease forwards 2.0s;
    }

    /* 区切り線 — 温かい色 */
    #splash .splash-line {
      width: 0;
      height: 1px;
      margin: 32px 0 28px;
      background: linear-gradient(90deg, transparent, rgba(244,164,96,0.5), transparent);
      animation: splash-line-grow 1s ease forwards 2.8s;
    }

    /* キーワード群 */
    .splash-keywords {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
      opacity: 0;
      animation: splash-fadein 1.2s ease forwards 3.2s;
    }
    .splash-keyword {
      padding: 6px 16px;
      border: 1px solid rgba(255,200,140,0.2);
      border-radius: 20px;
      font-size: clamp(11px, 1.6vw, 13px);
      color: rgba(255,220,180,0.75);
      letter-spacing: 0.08em;
      background: rgba(255,200,140,0.06);
    }

    /* ガイドテキスト */
    #splash .splash-guide {
      margin-top: 36px;
      padding: 10px 28px;
      font-size: clamp(11px, 1.8vw, 14px);
      color: rgba(255,220,180,0.85);
      background: rgba(255,200,140,0.08);
      border: 1px solid rgba(255,200,140,0.15);
      border-radius: 24px;
      opacity: 0;
      animation: splash-fadein 1s ease forwards 4.0s;
    }

    /* 地名テキスト */
    #splash .splash-location {
      margin-top: 24px;
      font-size: 11px;
      letter-spacing: 0.3em;
      color: rgba(255,200,140,0.3);
      opacity: 0;
      animation: splash-fadein 1s ease forwards 4.6s;
    }

    @keyframes splash-fadein {
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes splash-line-grow {
      to { width: min(240px, 55vw); }
    }

    /* ==========================================
       なつかし / いま 切り替えトグル
       ========================================== */
    #map-toggle {
      position: absolute;
      top: 10px;
      right: 56px;
      z-index: 1000;
      display: flex;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      overflow: hidden;
      user-select: none;
    }
    .map-toggle-btn {
      border: none;
      background: #fff;
      color: #555;
      font-size: 13px;
      font-weight: bold;
      padding: 7px 14px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      line-height: 1;
      white-space: nowrap;
    }
    .map-toggle-btn:first-child {
      border-right: 1px solid #eee;
    }
    .map-toggle-btn:hover {
      background: #f5f5f5;
    }
    .map-toggle-btn.active[data-map="old"] {
      background: #e8724a;
      color: #fff;
    }
    .map-toggle-btn.active[data-map="today"] {
      background: #2979FF;
      color: #fff;
    }

    /* ==========================================
       レイヤー切り替えパネル
       普段はアイコンだけ表示、ホバーで展開
       ========================================== */
    #layer-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      user-select: none;
    }

    /* トグルボタン（常に表示） */
    #layer-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: #fff;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      color: #555;
      transition: background 0.15s, color 0.15s;
      margin-left: auto;
    }
    #layer-toggle:hover {
      background: #f0f0f0;
      color: #000;
    }

    /* パネル本体（初期非表示） */
    #layer-body {
      display: none;
      margin-top: 6px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      padding: 10px 14px;
      font-size: 13px;
      min-width: 200px;
      animation: panel-fadein 0.15s ease;
    }

    #layer-body.open {
      display: block;
    }

    @keyframes panel-fadein {
      from { opacity: 0; transform: translateY(-4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    #layer-body .panel-title {
      font-size: 12px;
      font-weight: bold;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #layer-body .panel-group {
      margin-bottom: 6px;
    }

    #layer-body .panel-group-label {
      font-size: 11px;
      font-weight: bold;
      color: #27ae60;
      margin-bottom: 4px;
      padding-top: 6px;
      border-top: 1px solid #eee;
    }

    #layer-body .panel-group:first-of-type .panel-group-label {
      border-top: none;
      padding-top: 0;
    }

    #layer-body .panel-option {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px 0;
      cursor: pointer;
      color: #333;
    }

    #layer-body .panel-option:hover {
      color: #2980b9;
    }

    #layer-body .panel-option input[type="radio"] {
      margin: 0;
    }

    #layer-body .panel-note {
      margin-top: 8px;
      padding: 6px 8px;
      font-size: 11px;
      color: #e67e22;
      background: #fef9e7;
      border-radius: 4px;
      border: 1px solid #f0d58c;
      line-height: 1.4;
    }

    /* ==========================================
       パスワード入力フォーム
       ========================================== */
    .auth-form {
      min-width: 220px;
      text-align: center;
    }
    .auth-form h3 {
      margin: 0 0 6px;
      font-size: 14px;
      color: #2c3e50;
    }
    .auth-form p {
      margin: 0 0 10px;
      font-size: 12px;
      color: #777;
      line-height: 1.4;
    }
    .auth-form input[type="password"] {
      width: 100%;
      padding: 7px 10px;
      font-size: 14px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      outline: none;
      text-align: center;
      letter-spacing: 0.1em;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .auth-form input[type="password"]:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52,152,219,0.12);
    }
    .auth-form .auth-error {
      margin-top: 6px;
      font-size: 11px;
      color: #e74c3c;
      display: none;
    }
    .auth-form .submit-btn {
      display: block;
      width: 100%;
      margin-top: 10px;
      padding: 7px;
      font-size: 13px;
      font-weight: bold;
      color: #fff;
      background: linear-gradient(135deg, #27ae60, #219a52);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
      box-shadow: 0 2px 6px rgba(39,174,96,0.3);
    }
    .auth-form .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(39,174,96,0.35);
    }

    /* モード切替ボタン（右下） */
    #mode-toggle {
      position: absolute;
      bottom: 40px;
      right: 10px;
      z-index: 1000;
    }
    #mode-toggle button {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 600;
      border: none;
      border-radius: 18px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: background 0.2s, color 0.2s, transform 0.15s;
    }
    #mode-toggle button:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 12px rgba(0,0,0,0.25);
    }
    #mode-toggle button.mode-view {
      background: #fff;
      color: #555;
    }
    #mode-toggle button.mode-write {
      background: linear-gradient(135deg, #27ae60, #219a52);
      color: #fff;
    }
    #mode-toggle .mode-icon {
      width: 14px;
      height: 14px;
    }

    /* ==========================================
       画鋲マーカー（小さく丸いピン）
       ========================================== */
    .pin-marker {
      position: relative;
      cursor: pointer;
    }

    .pin-head {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1.5px solid rgba(255,255,255,0.8);
      box-shadow: 0 1px 4px rgba(0,0,0,0.35);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .pin-marker:hover .pin-head {
      transform: scale(1.6);
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    /* ながめるモードではピンを小さく */
    #map.mode-simple .pin-head {
      width: 8px;
      height: 8px;
    }
    #map.mode-simple .pin-marker .pin-badge {
      transform: scale(0.9);
      transform-origin: bottom left;
    }

    /* 件数バッジ（2件以上） */
    .pin-marker .pin-badge {
      position: absolute;
      top: -7px;
      right: -8px;
      min-width: 12px;
      height: 12px;
      padding: 0 2px;
      border-radius: 6px;
      background: #333;
      color: #fff;
      font-size: 8px;
      font-weight: 700;
      line-height: 12px;
      text-align: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.3);
      pointer-events: none;
    }

    /* ==========================================
       色選択パレット（フォーム内）
       ========================================== */
    .color-picker {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .color-picker .color-option {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 3px 8px 3px 4px;
      border: 1.5px solid #e0e0e0;
      border-radius: 14px;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      background: #fff;
    }

    .color-picker .color-option:hover {
      background: #f8f8f8;
      border-color: #bbb;
    }

    .color-picker .color-option.selected {
      border-color: #333;
      background: #f5f5f5;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
    }

    .color-picker .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .color-picker .color-label {
      font-size: 11px;
      color: #444;
      white-space: nowrap;
    }

    /* ==========================================
       マーカー ドロップアニメーション
       ========================================== */
    .leaflet-marker-icon {
      transition: transform 0.15s ease;
    }

    /* スプラッシュ中はマーカーとツールチップを隠す */
    .leaflet-marker-icon.marker-hidden {
      opacity: 0 !important;
      pointer-events: none;
    }
    .markers-hidden .leaflet-tooltip {
      opacity: 0 !important;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    /* ピンのぼんやり出現アニメーション */
    .marker-drop {
      animation: marker-fade-in 5s ease forwards;
    }
    @keyframes marker-fade-in {
      0%   { opacity: 0; }
      100% { opacity: 1; }
    }

    /* ==========================================
       ピン ぼんわりグロー
       ========================================== */
    .pin-marker {
      position: relative;
    }
    .pin-glow {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 26px;
      height: 26px;
      margin: -13px 0 0 -13px;
      border-radius: 50%;
      background: radial-gradient(circle, var(--pin-color) 0%, transparent 70%);
      opacity: 0.25;
      pointer-events: none;
      z-index: -1;
      animation: pin-glow-pulse 3s ease-in-out infinite;
    }
    @keyframes pin-glow-pulse {
      0%, 100% { transform: scale(1); opacity: 0.25; }
      50%      { transform: scale(1.5); opacity: 0.1; }
    }

    /* ==========================================
       クリック リップル
       ========================================== */
    .map-ripple {
      position: absolute;
      width: 40px; height: 40px;
      margin: -20px 0 0 -20px;
      border-radius: 50%;
      background: rgba(52,152,219,0.25);
      pointer-events: none;
      z-index: 800;
      animation: ripple-expand 0.5s ease forwards;
    }
    @keyframes ripple-expand {
      0%   { transform: scale(0); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }

    /* ==========================================
       ビネット（マップ周辺の自然なフレーム効果）
       ========================================== */
    #map-vignette {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 600;
      box-shadow: inset 0 0 80px rgba(0,0,0,0.15);
    }

    /* ==========================================
       トースト通知
       ========================================== */
    #toast-container {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    }

    .toast {
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: #fff;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      pointer-events: auto;
      animation: toast-in 0.3s ease forwards;
      white-space: nowrap;
    }
    .toast.hide {
      animation: toast-out 0.3s ease forwards;
    }
    .toast-success { background: #27ae60; }
    .toast-error   { background: #e74c3c; }
    .toast-info    { background: #2980b9; }

    @keyframes toast-in {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateY(0); }
      to   { opacity: 0; transform: translateY(-12px); }
    }

    /* ==========================================
       ステータスバー（下部）
       ========================================== */
    #status-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 6px 16px;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      color: rgba(255,255,255,0.85);
      font-size: 12px;
      letter-spacing: 0.03em;
    }
    #status-bar .stat-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #status-bar .stat-icon {
      width: 14px; height: 14px;
      opacity: 0.7;
    }

    /* ==========================================
       写真プレビュー
       ========================================== */
    .photo-preview {
      margin-top: 6px;
      max-height: 100px;
      border-radius: 4px;
      object-fit: cover;
      display: none;
      border: 1px solid #ddd;
    }
    .photo-preview.show {
      display: block;
      animation: fadein-fast 0.2s ease;
    }
    @keyframes fadein-fast {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    /* ==========================================
       ポップアップ改善
       ========================================== */
    .leaflet-popup-content-wrapper {
      border-radius: 10px !important;
      box-shadow: 0 4px 20px rgba(0,0,0,0.18) !important;
    }
    .leaflet-popup-tip {
      box-shadow: 0 2px 8px rgba(0,0,0,0.12) !important;
    }

    /* カスタムスクロールバー */
    .spot-popup .memories-list::-webkit-scrollbar {
      width: 5px;
    }
    .spot-popup .memories-list::-webkit-scrollbar-track {
      background: transparent;
    }
    .spot-popup .memories-list::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.15);
      border-radius: 3px;
    }
    .spot-popup .memories-list::-webkit-scrollbar-thumb:hover {
      background: rgba(0,0,0,0.3);
    }

    /* ==========================================
       入力フォーム（新規スポット & 追加投稿共通）
       ========================================== */
    .memory-form {
      min-width: 260px;
    }

    .memory-form h3 {
      margin: 0 0 10px;
      font-size: 15px;
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 6px;
    }

    .memory-form label {
      display: block;
      margin-top: 6px;
      margin-bottom: 2px;
      font-size: 13px;
      font-weight: bold;
      color: #34495e;
    }

    .memory-form input[type="text"],
    .memory-form textarea {
      width: 100%;
      padding: 6px 8px;
      font-size: 13px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .memory-form input[type="text"]:focus,
    .memory-form textarea:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52,152,219,0.12);
    }

    .memory-form textarea {
      height: 70px;
      resize: vertical;
    }

    .memory-form input[type="file"] {
      margin-top: 4px;
      font-size: 12px;
    }

    .memory-form .submit-btn,
    .modal-card-footer .submit-btn {
      display: block;
      width: 100%;
      margin-top: 0;
      padding: 10px;
      font-size: 15px;
      font-weight: bold;
      color: #fff;
      background: linear-gradient(135deg, #3498db, #2980b9);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s, background 0.2s;
      box-shadow: 0 2px 8px rgba(52,152,219,0.3);
    }

    .memory-form .submit-btn:hover,
    .modal-card-footer .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(52,152,219,0.35);
    }
    .memory-form .submit-btn:active,
    .modal-card-footer .submit-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(52,152,219,0.3);
    }
    .memory-form .submit-btn:disabled,
    .modal-card-footer .submit-btn:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ==========================================
       スポットポップアップ（思い出一覧）
       ========================================== */
    .spot-popup {
      min-width: 280px;
    }

    .spot-popup .spot-header {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin: 0 0 8px;
      padding-bottom: 6px;
      border-bottom: 2px solid #27ae60;
    }

    .spot-popup .spot-header h3 {
      margin: 0;
      font-size: 15px;
      color: #2c3e50;
    }

    .spot-popup .rename-btn {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 13px;
      color: #aaa;
      padding: 0 2px;
      line-height: 1;
      transition: color 0.15s;
    }
    .spot-popup .rename-btn:hover {
      color: #555;
    }

    .spot-popup .rename-inline {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 6px;
    }
    .spot-popup .rename-inline input {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 13px;
      font-family: inherit;
    }
    .spot-popup .rename-inline input:focus {
      outline: none;
      border-color: #27ae60;
    }
    .spot-popup .rename-inline button {
      border: none;
      background: #27ae60;
      color: #fff;
      font-size: 11px;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      white-space: nowrap;
    }
    .spot-popup .rename-inline button:hover {
      background: #219a52;
    }

    .spot-popup .memory-count {
      font-size: 12px;
      color: #888;
      font-weight: normal;
    }

    .spot-popup .memories-list {
      max-height: 280px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .spot-popup .memory-item {
      padding: 10px 0;
      border-bottom: 1px dashed #ddd;
    }

    .spot-popup .memory-item:last-child { border-bottom: none; }

    .spot-popup .memory-item .saved-name {
      font-weight: bold;
      font-size: 13px;
      color: #2c3e50;
      margin-bottom: 4px;
    }

    .spot-popup .memory-item .saved-memory {
      font-size: 13px;
      color: #555;
      white-space: pre-wrap;
      word-break: break-word;
      margin-bottom: 6px;
    }

    .spot-popup .memory-item .saved-photo-wrap {
      position: relative;
      margin-bottom: 6px;
    }
    .spot-popup .memory-item .saved-photo {
      width: 100%;
      max-height: 160px;
      object-fit: cover;
      border-radius: 4px;
      display: block;
    }
    .spot-popup .memory-item .photo-delete-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      padding: 2px 8px;
      font-size: 10px;
      color: #fff;
      background: rgba(0,0,0,0.55);
      border: none;
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .spot-popup .memory-item .photo-delete-btn:hover {
      background: rgba(231,76,60,0.85);
    }

    .spot-popup .memory-item .saved-date {
      font-size: 11px;
      color: #999;
      margin-bottom: 4px;
    }

    .spot-popup .memory-item .memory-actions {
      display: flex;
      gap: 0;
      margin-top: 6px;
      border-top: 1px solid #f0f0f0;
      padding-top: 6px;
    }
    .spot-popup .memory-item .memory-actions button {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 6px 0;
      border: none;
      background: none;
      font-size: 11px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.15s;
    }
    .spot-popup .memory-item .edit-btn {
      color: #2979FF;
    }
    .spot-popup .memory-item .edit-btn:hover {
      background: rgba(41,121,255,0.08);
    }
    .spot-popup .memory-item .delete-btn {
      color: #e74c3c;
    }
    .spot-popup .memory-item .delete-btn:hover {
      background: rgba(231,76,60,0.08);
    }

    .spot-popup .memory-item .edit-inline textarea {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px 8px;
      font-size: 12px;
      font-family: inherit;
      resize: vertical;
      height: 60px;
      margin-bottom: 4px;
    }
    .spot-popup .memory-item .edit-inline textarea:focus {
      outline: none;
      border-color: #2979FF;
    }
    .spot-popup .memory-item .edit-inline-actions {
      display: flex;
      gap: 4px;
    }
    .spot-popup .memory-item .edit-inline-actions button {
      border: none;
      font-size: 11px;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .spot-popup .memory-item .edit-save-btn {
      background: #2979FF;
      color: #fff;
    }
    .spot-popup .memory-item .edit-save-btn:hover { background: #1565C0; }
    .spot-popup .memory-item .edit-cancel-btn {
      background: #eee;
      color: #555;
    }
    .spot-popup .memory-item .edit-cancel-btn:hover { background: #ddd; }

    .spot-popup .spot-category {
      font-size: 11px;
      font-weight: 600;
    }

    .spot-popup .spot-color-picker {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .spot-popup .spot-color-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: border-color 0.15s, transform 0.1s;
    }
    .spot-popup .spot-color-btn:hover {
      transform: scale(1.2);
    }
    .spot-popup .spot-color-btn.selected {
      border-color: #333;
    }
    .spot-popup .spot-color-btn .color-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .spot-popup .add-toggle-btn {
      display: block;
      width: 100%;
      margin-top: 10px;
      padding: 7px;
      font-size: 13px;
      font-weight: bold;
      color: #27ae60;
      background: #f0faf4;
      border: 1px solid #27ae60;
      border-radius: 4px;
      cursor: pointer;
    }

    .spot-popup .add-toggle-btn:hover { background: #dff5e7; }

    /* ==========================================
       思い出モード — モーダルオーバーレイ
       ========================================== */
    #memory-overlay {
      position: fixed;
      inset: 0;
      z-index: 8000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s ease;
    }
    #memory-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* 背景のグレーベール */
    #memory-overlay .overlay-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(30, 30, 30, 0.72);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }

    /* モーダルカード */
    #memory-overlay .modal-card {
      position: relative;
      z-index: 1;
      width: 92%;
      max-width: 400px;
      max-height: 88vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.3);
      padding: 0;
      animation: modal-rise 0.35s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    #memory-overlay .modal-card-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 28px 24px 8px;
    }
    #memory-overlay .modal-card-footer {
      padding: 0 24px 20px;
      background: #fff;
      position: relative;
    }
    #memory-overlay .modal-card-footer::before {
      content: '';
      position: absolute;
      top: -24px;
      left: 0;
      right: 0;
      height: 24px;
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,1));
      pointer-events: none;
    }
    @keyframes modal-rise {
      0%   { opacity: 0; transform: translateY(30px) scale(0.95); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* 閉じるボタン */
    #memory-overlay .modal-close {
      position: absolute;
      top: 12px;
      right: 14px;
      z-index: 2;
      width: 28px;
      height: 28px;
      border: none;
      background: rgba(0,0,0,0.06);
      border-radius: 50%;
      font-size: 16px;
      color: #888;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
    }
    #memory-overlay .modal-close:hover {
      background: rgba(0,0,0,0.12);
      color: #333;
    }

    /* モーダル内フォーム微調整 */
    #memory-overlay .memory-form {
      min-width: unset;
    }
    #memory-overlay .memory-form h3 {
      font-size: 17px;
      margin-bottom: 14px;
      padding-bottom: 8px;
    }
    #memory-overlay .memory-form textarea {
      height: 90px;
    }

    /* モーダル内の認証フォーム */
    #memory-overlay .auth-form {
      min-width: unset;
    }
    #memory-overlay .auth-form h3 {
      font-size: 16px;
    }

    /* モーダル用スクロールバー */
    #memory-overlay .modal-card-scroll::-webkit-scrollbar {
      width: 5px;
    }
    #memory-overlay .modal-card-scroll::-webkit-scrollbar-track {
      background: transparent;
    }
    #memory-overlay .modal-card-scroll::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.12);
      border-radius: 3px;
    }
    /* ==========================================
       アルバムボタン（トグル直下）
       ========================================== */
    #btn-album {
      position: absolute;
      top: 46px;
      right: 56px;
      z-index: 1000;
      border: none;
      background: #fff;
      color: #555;
      font-size: 12px;
      font-weight: bold;
      padding: 6px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      line-height: 1;
      white-space: nowrap;
      user-select: none;
      transition: background 0.2s, color 0.2s, transform 0.15s;
    }
    #btn-album:hover {
      background: #f0ebe6;
      transform: scale(1.04);
    }
    #btn-album.active {
      background: #6D4C41;
      color: #fff;
    }

    /* ==========================================
       アルバムオーバーレイ（モード切替エフェクト付き）
       ========================================== */
    #album-overlay {
      position: fixed;
      inset: 0;
      z-index: 7000;
      background: #f5f5f0;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.45s ease, visibility 0.45s ease;
    }
    #album-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* マップ側のフェードアウト */
    #app.album-active {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s ease;
    }
    #app {
      transition: opacity 0.35s ease;
    }

    .album-header {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .album-header-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .album-header h2 {
      margin: 0;
      font-size: 18px;
      color: #333;
    }
    #album-toggle {
      display: flex;
      background: #f0f0f0;
      border-radius: 6px;
      overflow: hidden;
    }
    .album-toggle-btn {
      border: none;
      background: transparent;
      color: #888;
      font-size: 12px;
      font-weight: bold;
      padding: 5px 12px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      line-height: 1;
      white-space: nowrap;
    }
    .album-toggle-btn:hover {
      background: rgba(0,0,0,0.06);
    }
    .album-toggle-btn.active[data-album-map="old"] {
      background: #e8724a;
      color: #fff;
    }
    .album-toggle-btn.active[data-album-map="today"] {
      background: #2979FF;
      color: #fff;
    }
    .album-close {
      border: none;
      background: rgba(0,0,0,0.06);
      width: 34px;
      height: 34px;
      border-radius: 50%;
      font-size: 20px;
      color: #888;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
    }
    .album-close:hover {
      background: rgba(0,0,0,0.12);
      color: #333;
    }
    #album-body {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .album-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      opacity: 0;
      transform: translateY(18px);
      animation: album-card-in 0.4s ease forwards;
    }
    @keyframes album-card-in {
      to { opacity: 1; transform: translateY(0); }
    }
    .album-card-place {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 15px;
      font-weight: bold;
      color: #2c3e50;
    }
    .album-card-place .color-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .album-card-name {
      font-size: 13px;
      font-weight: bold;
      color: #2c3e50;
    }
    .album-card-era {
      font-size: 12px;
      color: #888;
    }
    .album-card-memory {
      font-size: 13px;
      color: #555;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.6;
    }
    .album-card-photo {
      width: 100%;
      max-height: 240px;
      object-fit: cover;
      border-radius: 6px;
    }
    .album-card-date {
      font-size: 11px;
      color: #999;
    }
    .album-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: #999;
      font-size: 15px;
    }
    @media (max-width: 640px) {
      #album-body {
        grid-template-columns: 1fr;
        padding: 12px;
        gap: 12px;
      }
    }

    /* ==========================================
       ピン配置確認バー（上部中央フローティング）
       ========================================== */
    #pin-confirm-bar {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1200;
      display: none;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      background: #fff;
      border-radius: 28px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      font-size: 13px;
      color: #333;
      white-space: nowrap;
      animation: confirm-bar-in 0.3s ease forwards;
    }
    #pin-confirm-bar.active {
      display: flex;
    }
    @keyframes confirm-bar-in {
      from { opacity: 0; transform: translateX(-50%) translateY(-12px); }
      to   { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    #pin-confirm-bar .confirm-msg {
      font-weight: 500;
    }
    #pin-confirm-bar .confirm-btn {
      padding: 6px 16px;
      font-size: 13px;
      font-weight: bold;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    #pin-confirm-bar .confirm-btn:hover {
      transform: translateY(-1px);
    }
    #pin-confirm-bar .btn-confirm {
      color: #fff;
      background: linear-gradient(135deg, #3498db, #2980b9);
      box-shadow: 0 2px 6px rgba(52,152,219,0.3);
    }
    #pin-confirm-bar .btn-cancel {
      color: #666;
      background: #f0f0f0;
    }
    #pin-confirm-bar .btn-cancel:hover {
      background: #e0e0e0;
    }

    /* 配置中ピンのパルスアニメーション */
    .pin-placing .pin-head {
      background: #3B82F6 !important;
      position: relative;
      animation: pin-pulse 1.5s ease-in-out infinite;
    }
    .pin-placing .pin-head::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 4px;
      height: 4px;
      margin: -2px 0 0 -2px;
      border-radius: 50%;
      border: 1.5px solid #3B82F6;
      animation: pin-ring 1.5s ease-out infinite;
    }
    @keyframes pin-pulse {
      0%, 100% { transform: scale(1); }
      50%      { transform: scale(1.2); }
    }
    @keyframes pin-ring {
      0%   { transform: scale(1); opacity: 0.8; }
      100% { transform: scale(2.5); opacity: 0; }
    }

    /* ==========================================
       問い合わせボタン・モーダル（左下）
       ========================================== */
    #contact-panel {
      position: absolute;
      bottom: 80px;
      left: 10px;
      z-index: 1000;
      user-select: none;
    }
    #contact-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: #fff;
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      color: #555;
      font-size: 15px;
      transition: background 0.15s, color 0.15s;
    }
    #contact-toggle:hover {
      background: #f0f0f0;
      color: #000;
    }
    #contact-body {
      display: none;
      position: absolute;
      bottom: 40px;
      left: 0;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      padding: 14px 16px;
      font-size: 13px;
      min-width: 260px;
      max-width: 300px;
      animation: contact-pop 0.2s ease forwards;
    }
    @keyframes contact-pop {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    #contact-body.open {
      display: block;
    }
    #contact-body .contact-title {
      font-weight: bold;
      font-size: 14px;
      color: #333;
      margin-bottom: 10px;
    }
    #contact-body label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #555;
      margin-bottom: 3px;
    }
    #contact-body input,
    #contact-body textarea {
      display: block;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 7px 9px;
      font-size: 13px;
      font-family: inherit;
      margin-bottom: 10px;
      transition: border-color 0.2s;
    }
    #contact-body input:focus,
    #contact-body textarea:focus {
      outline: none;
      border-color: #999;
    }
    #contact-body textarea {
      height: 70px;
      resize: vertical;
    }
    #contact-body .contact-submit {
      display: block;
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 8px;
      background: #2979FF;
      color: #fff;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    #contact-body .contact-submit:hover {
      background: #1565C0;
    }

    /* ==========================================
       ヘルプパネル（左下）
       ========================================== */
    /* ==========================================
       なつかしマップとは？ボタン（かきこむの上）
       ========================================== */
    #btn-about {
      position: absolute;
      bottom: 80px;
      right: 10px;
      z-index: 1000;
      border: none;
      background: #fff;
      color: #555;
      font-size: 11px;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      line-height: 1;
      white-space: nowrap;
      user-select: none;
      transition: background 0.2s, color 0.2s, transform 0.15s;
    }
    #btn-about:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 12px rgba(0,0,0,0.25);
    }

    /* このサイトについてオーバーレイ */
    #about-overlay {
      position: fixed;
      inset: 0;
      z-index: 8000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s ease;
    }
    #about-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    #about-overlay .overlay-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(30, 30, 30, 0.72);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    #about-overlay .modal-card {
      position: relative;
      z-index: 1;
      width: 92%;
      max-width: 420px;
      max-height: 88vh;
      overflow-y: auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.3);
      padding: 28px 24px 24px;
      animation: modal-rise 0.35s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    #about-overlay .modal-close {
      position: absolute;
      top: 12px;
      right: 14px;
      z-index: 2;
      width: 28px;
      height: 28px;
      border: none;
      background: rgba(0,0,0,0.06);
      border-radius: 50%;
      font-size: 16px;
      color: #888;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
    }
    #about-overlay .modal-close:hover {
      background: rgba(0,0,0,0.12);
      color: #333;
    }
    #about-overlay .about-title {
      font-size: 17px;
      font-weight: bold;
      color: #5D4037;
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 2px solid #A1887F;
    }
    #about-overlay .about-text {
      font-size: 13.5px;
      line-height: 1.9;
      color: #444;
    }
    #about-overlay .about-text p {
      margin-bottom: 12px;
    }
    #about-overlay .about-text p:last-child {
      margin-bottom: 0;
    }
    #about-overlay .about-section-label {
      font-size: 12px;
      font-weight: bold;
      color: #8D6E63;
      margin: 16px 0 6px;
      letter-spacing: 0.5px;
    }
    #about-overlay .about-features {
      list-style: none;
      padding: 0;
      margin: 0 0 8px;
    }
    #about-overlay .about-features li {
      font-size: 12.5px;
      color: #555;
      padding: 4px 0;
      padding-left: 16px;
      position: relative;
      line-height: 1.7;
    }
    #about-overlay .about-features li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 10px;
      width: 7px;
      height: 7px;
      background: #A1887F;
      border-radius: 50%;
    }
    #about-overlay .about-credit {
      margin-top: 16px;
      padding-top: 10px;
      border-top: 1px solid #eee;
      font-size: 11.5px;
      color: #999;
      line-height: 1.6;
    }
    #about-overlay .modal-card::-webkit-scrollbar {
      width: 5px;
    }
    #about-overlay .modal-card::-webkit-scrollbar-track {
      background: transparent;
    }
    #about-overlay .modal-card::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.12);
      border-radius: 3px;
    }

    #help-panel {
      position: absolute;
      bottom: 40px;
      left: 10px;
      z-index: 1000;
      user-select: none;
    }
    #help-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: #fff;
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      color: #555;
      font-size: 16px;
      font-weight: bold;
      transition: background 0.15s, color 0.15s;
    }
    #help-toggle:hover {
      background: #f0f0f0;
      color: #000;
    }
    #help-body {
      display: none;
      position: absolute;
      bottom: 40px;
      left: 0;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      padding: 12px 14px;
      font-size: 12px;
      min-width: 220px;
      max-width: 260px;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      animation: help-fadein 0.2s ease;
    }
    #help-body.open {
      display: block;
    }
    @keyframes help-fadein {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    #help-body .help-title {
      font-size: 12px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 2px solid #3498db;
    }
    #help-body .help-steps {
      list-style: none;
      padding: 0;
      margin: 0 0 8px;
    }
    #help-body .help-steps li {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 5px;
      font-size: 11px;
      color: #444;
      line-height: 1.4;
    }
    #help-body .help-steps .step-num {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #3498db;
      color: #fff;
      font-size: 9px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #help-body .help-tips {
      padding-top: 8px;
      border-top: 1px solid #eee;
      font-size: 10px;
      color: #888;
      line-height: 1.5;
    }
    #help-body .help-legend-title {
      font-size: 11px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 4px;
    }
    #help-body .help-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 2px 6px;
      margin-bottom: 8px;
    }
    #help-body .help-legend-item {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 9px;
      color: #555;
    }
    #help-body .help-legend-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    #help-body kbd {
      display: inline-block;
      padding: 1px 5px;
      font-size: 11px;
      font-family: inherit;
      background: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 3px;
      box-shadow: 0 1px 0 #bbb;
      line-height: 1.4;
    }

    @media (max-width: 480px) {
      #pin-confirm-bar {
        left: 8px;
        right: 8px;
        transform: none;
        white-space: normal;
        font-size: 12px;
        padding: 8px 14px;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
      }
      #pin-confirm-bar.active {
        display: flex;
      }
      @keyframes confirm-bar-in {
        from { opacity: 0; transform: translateY(-12px); }
        to   { opacity: 1; transform: translateY(0); }
      }
      #help-body {
        min-width: 180px;
        max-width: calc(100vw - 60px);
        max-height: calc(100vh - 100px);
      }
    }

    /* ==========================================
       ピン プレビューカード（ズームで浮かび上がる）
       ========================================== */
    .spot-preview {
      background: #fff !important;
      border: none !important;
      border-radius: 10px !important;
      box-shadow: 0 4px 16px rgba(0,0,0,0.18) !important;
      padding: 0 !important;
      max-width: 240px;
      font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      opacity: 0 !important;
      transform: translateY(8px);
      pointer-events: none;
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .spot-preview::before {
      border-top-color: #fff !important;
      transition: opacity 0.5s ease;
    }
    /* ホバー時にふわっと浮かび上がる */
    .spot-preview.spot-preview-hover {
      opacity: 1 !important;
      transform: translateY(0);
    }
    /* ポップアップ表示中はプレビューを隠す */
    .spot-preview.tooltip-suppressed {
      opacity: 0 !important;
      transform: translateY(8px) !important;
    }
    .spot-preview .spot-tt-inner {
      padding: 10px 12px;
    }
    .spot-preview .spot-tt-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .spot-preview .spot-tt-name {
      font-size: 13px;
      font-weight: 700;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 160px;
    }
    .spot-preview .spot-tt-cat {
      font-size: 10px;
      font-weight: 600;
      white-space: nowrap;
    }
    .spot-preview .spot-tt-text {
      font-size: 11px;
      color: #555;
      line-height: 1.5;
      margin-top: 2px;
      word-break: break-word;
      overflow-wrap: break-word;
      white-space: normal;
    }
    .spot-preview .spot-tt-photo {
      width: 100%;
      max-height: 80px;
      object-fit: cover;
      border-radius: 6px;
      margin-top: 6px;
      display: block;
    }
    .spot-preview .spot-tt-more {
      font-size: 10px;
      color: #999;
      margin-top: 4px;
    }
    .spot-preview .spot-tt-empty {
      font-size: 11px;
      color: #aaa;
      margin-top: 2px;
    }
    /* 時期ラベル — ポップアップ内 */
    .saved-era {
      font-size: 11px;
      color: #888;
      margin-bottom: 2px;
    }
    /* 時期ラベル — プレビューカード内 */
    .spot-preview .spot-tt-era {
      font-size: 10px;
      color: #999;
      margin-bottom: 2px;
    }
  </style>
</head>
<body>

<!-- ==================================================
     スプラッシュ画面（導入アニメーション）
     ================================================== -->
<div id="splash">
  <!-- 漂う光の粒 -->
  <div class="splash-particle" style="width:3px;height:3px;left:15%;bottom:-10%;animation-duration:7s;animation-delay:0s;"></div>
  <div class="splash-particle" style="width:2px;height:2px;left:35%;bottom:-10%;animation-duration:9s;animation-delay:1.2s;"></div>
  <div class="splash-particle" style="width:4px;height:4px;left:55%;bottom:-10%;animation-duration:8s;animation-delay:0.5s;"></div>
  <div class="splash-particle" style="width:2px;height:2px;left:72%;bottom:-10%;animation-duration:10s;animation-delay:2s;"></div>
  <div class="splash-particle" style="width:3px;height:3px;left:88%;bottom:-10%;animation-duration:7.5s;animation-delay:3s;"></div>
  <div class="splash-particle" style="width:2px;height:2px;left:25%;bottom:-10%;animation-duration:11s;animation-delay:1.8s;"></div>
  <div class="splash-particle" style="width:3px;height:3px;left:65%;bottom:-10%;animation-duration:8.5s;animation-delay:0.8s;"></div>

  <div class="splash-content">

    <!-- ピンアイコン（温かい色合い） -->
    <svg class="splash-logo" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M28 4C18.06 4 10 11.72 10 21.2C10 34.4 28 52 28 52C28 52 46 34.4 46 21.2C46 11.72 37.94 4 28 4Z" fill="#e8724a" opacity="0.95"/>
      <circle cx="28" cy="21" r="8" fill="#fff" opacity="0.9"/>
      <circle cx="28" cy="21" r="4" fill="#e8724a" opacity="0.5"/>
    </svg>

    <div class="splash-title">志津川<br>なつかしマップ</div>
    <div class="splash-sub">あの頃の街を、みんなの記憶でたどる</div>

    <div class="splash-line"></div>

    <div class="splash-keywords">
      <span class="splash-keyword">写真を残す</span>
      <span class="splash-keyword">思い出を書く</span>
      <span class="splash-keyword">みんなで共有</span>
    </div>

    <div class="splash-guide">ピンをタップして、街の記憶をのぞいてみよう</div>

    <div class="splash-location">宮城県南三陸町 志津川</div>

  </div>
</div>

<!-- トースト通知 -->
<div id="toast-container"></div>

<!-- このサイトについてオーバーレイ -->
<div id="about-overlay">
  <div class="overlay-backdrop"></div>
  <div class="modal-card">
    <button class="modal-close" id="about-close-btn">&times;</button>
    <div class="about-title">志津川なつかしマップ・デジタルとは</div>
    <div class="about-text">
      <p>
        宮城県南三陸町志津川——かつてそこにあった街並み、お店、学校、遊び場。
        2011年の東日本大震災で街の姿は大きく変わりましたが、
        人々の記憶のなかには、あの頃の風景がいまも鮮やかに残っています。
      </p>
      <p>
        「志津川なつかしマップ・デジタル」は、
        そうした一人ひとりの思い出を地図の上に集め、
        みんなで分かち合うためのデジタルマップです。
        テーマは「過去に寄り添う」。
      </p>
      <p>
        「あそこにはこんなお店があった」「放課後はよくあの場所で遊んだ」——
        そんな記憶をピンと一緒にマップに残すことで、
        懐かしい街のすがたをもう一度みんなで描き出すことができます。
      </p>
    </div>

    <div class="about-section-label">2つのマップ</div>
    <ul class="about-features">
      <li>「なつかし」マップ：震災前の街並みを描いた手描きの地図に、あの頃の思い出を残せます</li>
      <li>「いま」マップ：震災後の街に刻まれた新しい思い出や、変わりゆく風景を記録できます</li>
    </ul>

    <div class="about-section-label">できること</div>
    <ul class="about-features">
      <li>マップの上にピンを置いて思い出を投稿</li>
      <li>写真を添えて、当時の風景を記録</li>
      <li>ほかの人が残した思い出を読む</li>
      <li>「なつかし」と「いま」の地図を切り替えて見くらべる</li>
      <li>アルバムで投稿を一覧表示</li>
    </ul>

    <div class="about-section-label">つかいかた</div>
    <ul class="about-features">
      <li>ピンをタップすると、その場所の思い出が読めます</li>
      <li>右上の「なつかし」「いま」で地図を切り替え</li>
      <li>思い出を書きこむには、右下の「かきこむ」ボタンから</li>
      <li>左下の「?」ボタンでくわしい操作ガイドを表示</li>
    </ul>

    <div class="about-credit">
      志津川なつかしマップの制作：一般社団法人 復興みなさん会<br>
      デジタル版の制作：菅原裕輝（大阪大学大学院人文学研究科）
    </div>
  </div>
</div>

<!-- 思い出モード — モーダルオーバーレイ -->
<div id="memory-overlay">
  <div class="overlay-backdrop"></div>
  <div class="modal-card">
    <button class="modal-close" id="modal-close-btn">&times;</button>
    <div class="modal-card-scroll">
      <div id="modal-body"></div>
    </div>
    <div class="modal-card-footer" id="modal-footer"></div>
  </div>
</div>

<div id="album-overlay">
  <div class="album-header">
    <div class="album-header-left">
      <h2>みんなの思い出</h2>
      <div id="album-toggle">
        <button class="album-toggle-btn active" data-album-map="old">なつかし</button>
        <button class="album-toggle-btn" data-album-map="today">いま</button>
      </div>
    </div>
    <button class="album-close" id="album-close-btn" title="マップに戻る">&times;</button>
  </div>
  <div id="album-body"></div>
</div>

<!-- マップとレイヤーパネルのラッパー -->
<div id="app">
  <div id="map"></div>
  <div id="map-vignette"></div>

  <!-- なつかし / いま 切り替えトグル -->
  <div id="map-toggle">
    <button id="btn-map-old" class="map-toggle-btn active" data-map="old">なつかし</button>
    <button id="btn-map-today" class="map-toggle-btn" data-map="today">いま</button>
  </div>

  <button id="btn-album" title="アルバム">&#x1f4d6; アルバム</button>
  <button id="btn-about">なつかしマップとは？</button>

  <!-- ==================================================
       レイヤー切り替えパネル（マップ外に配置）
       マップを破棄・再生成してもこの DOM は保持される
       ================================================== -->
  <div id="layer-panel">
    <!-- トグルボタン（常に表示されるアイコン） -->
    <button id="layer-toggle" title="レイヤー選択">
      <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 2L1 6.5 9 11l8-4.5L9 2z"/>
        <path d="M1 11.5L9 16l8-4.5"/>
        <path d="M1 9L9 13.5 17 9"/>
      </svg>
    </button>

    <!-- パネル本体（トグルで開閉） -->
    <div id="layer-body">
      <div class="panel-title">レイヤー選択</div>

      <div class="panel-group">
        <div class="panel-group-label">参考地図（志津川周辺）</div>
        <label class="panel-option">
          <input type="radio" name="layer" value="osm">
          OpenStreetMap
        </label>
        <label class="panel-option">
          <input type="radio" name="layer" value="gsi-std">
          国土地理院 標準地図
        </label>
        <label class="panel-option">
          <input type="radio" name="layer" value="gsi-photo">
          国土地理院 航空写真
        </label>
      </div>

      <div class="panel-note" id="tile-note" style="display:none;">
        参考地図モードではピンの表示・追加はできません。<br>
        志津川マップに戻すにはこのパネルを閉じて<br>
        右上の「なつかし」「いま」ボタンを押してください。
      </div>
    </div>
  </div>

  <!-- ピン配置確認バー -->
  <div id="pin-confirm-bar">
    <span class="confirm-msg">ピンをドラッグして位置を調整</span>
    <button class="confirm-btn btn-confirm" id="btn-pin-confirm">ここに決定</button>
    <button class="confirm-btn btn-cancel" id="btn-pin-cancel">キャンセル</button>
  </div>

  <!-- 問い合わせパネル（左下） -->
  <div id="contact-panel">
    <button id="contact-toggle" title="お問い合わせ">&#x2709;</button>
    <div id="contact-body">
      <div class="contact-title">お問い合わせ</div>
      <label for="contact-name">お名前</label>
      <input type="text" id="contact-name" placeholder="お名前を入力">
      <label for="contact-email">メールアドレス</label>
      <input type="email" id="contact-email" placeholder="example@mail.com">
      <label for="contact-message">ききたいこと</label>
      <textarea id="contact-message" placeholder="お気軽にどうぞ"></textarea>
      <button class="contact-submit" id="contact-submit">送信する</button>
    </div>
  </div>

  <!-- ヘルプパネル（左下） -->
  <div id="help-panel">
    <button id="help-toggle" title="使い方ガイド">?</button>
    <div id="help-body">
      <!-- ながめる人向けガイド -->
      <div id="help-view" class="help-section">
        <div class="help-title">使い方ガイド（ながめる）</div>
        <ul class="help-steps">
          <li><span class="step-num">1</span>ピンをクリックして思い出を読む</li>
          <li><span class="step-num">2</span>右上の「なつかし」「いま」で地図を切り替え</li>
          <li><span class="step-num">3</span>「アルバム」ボタンで思い出を一覧表示</li>
        </ul>
        <div class="help-legend-title">ピンの色（カテゴリ）</div>
        <div class="help-legend">
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#FF1744"></span>商店・買い物</span>
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#FF6D00"></span>食事・飲食</span>
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#FFD600"></span>学校・教育</span>
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#00E676"></span>自然・公園</span>
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#2979FF"></span>公共施設</span>
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#FF4081"></span>暮らし・交流</span>
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#D500F9"></span>その他</span>
        </div>
        <div class="help-tips">
          思い出をかきこむには、右下の「かきこむ」ボタンを押してください<br>
          （初回のみパスワードが必要です）
        </div>
      </div>
      <!-- かきこむ人向けガイド -->
      <div id="help-write" class="help-section" style="display:none;">
        <div class="help-title">使い方ガイド（かきこむ）</div>
        <ul class="help-steps">
          <li><span class="step-num">1</span>地図上をクリックしてピンを置く</li>
          <li><span class="step-num">2</span>ドラッグしてピンの位置を調整</li>
          <li><span class="step-num">3</span>「ここに決定」で場所を確定</li>
          <li><span class="step-num">4</span>思い出やお名前、写真を入力して保存</li>
        </ul>
        <div class="help-legend-title">ピンの色（カテゴリ）</div>
        <div class="help-legend">
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#FF1744"></span>商店・買い物</span>
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#FF6D00"></span>食事・飲食</span>
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#FFD600"></span>学校・教育</span>
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#00E676"></span>自然・公園</span>
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#2979FF"></span>公共施設</span>
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#FF4081"></span>暮らし・交流</span>
          <span class="help-legend-item"><span class="help-legend-dot" style="background:#D500F9"></span>その他</span>
        </div>
        <div class="help-tips">
          既存のピンをクリックして思い出を追加することもできます<br>
          「ながめる」ボタンを押すと閲覧モードに戻ります
        </div>
      </div>
    </div>
  </div>

  <!-- ステータスバー -->
  <div id="status-bar">
    <div class="stat-item">
      <svg class="stat-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round">
        <path d="M8 1C5.24 1 3 3.14 3 5.8C3 9.4 8 15 8 15s5-5.6 5-9.2C13 3.14 10.76 1 8 1z"/>
        <circle cx="8" cy="5.8" r="1.8"/>
      </svg>
      <span>スポット: <strong id="stat-spots">0</strong></span>
    </div>
    <div class="stat-item">
      <svg class="stat-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 3h10v8.5H6.5L3 14V3z"/>
        <line x1="5.5" y1="6" x2="10.5" y2="6"/>
        <line x1="5.5" y1="8.5" x2="8.5" y2="8.5"/>
      </svg>
      <span>思い出: <strong id="stat-memories">0</strong></span>
    </div>
    <div class="stat-item" style="opacity:0.6;">
      志津川なつかしマップ・デジタル<span style="opacity:0.5;font-size:10px;margin-left:4px;">v0.1</span>
    </div>
  </div>

  <!-- モード切替ボタン（右下） -->
  <div id="mode-toggle">
    <button id="btn-mode-toggle" class="mode-view" title="かきこむモードに切り替え">
      <svg class="mode-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
        <path d="M11.5 1.5l3 3L5 14H2v-3L11.5 1.5z"/>
      </svg>
      <span id="mode-label">かきこむ</span>
    </button>
  </div>
</div>

<script>
  // ==================================================
  // Firebase 設定（プレースホルダー）
  // ご自身のFirebaseプロジェクトの値に置き換えてください
  // ==================================================
  var firebaseConfig = {
    apiKey:            "AIzaSyARVLXwp7t_WaGP1grG8yQL0ru--hMHEl0",
    authDomain:        "shizugawa-map.firebaseapp.com",
    projectId:         "shizugawa-map",
    storageBucket:     "shizugawa-map.firebasestorage.app",
    messagingSenderId: "1067176596182",
    appId:             "1:1067176596182:web:fd3cf446afb34ed53e6f77"
  };

  // Firebase が設定済みかどうかを判定
  var useFirebase = firebaseConfig.apiKey !== 'YOUR_API_KEY';

  var db, storage;

  if (useFirebase) {
    // --- Firebase モード ---
    firebase.initializeApp(firebaseConfig);
    db      = firebase.firestore();
    storage = firebase.storage();
  } else {
    // --- LocalStorage フォールバックモード ---
    // Firebase と同じ API インターフェースを提供するアダプター
    console.log('%c[ローカルモード] Firebase 未設定のため LocalStorage で動作します',
      'color:#e67e22;font-weight:bold');

    var LS_KEY = 'shizugawa_map_data';

    function lsRead() {
      try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; }
      catch (e) { return {}; }
    }
    function lsWrite(data) {
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    }
    function lsGenId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
    }

    // Firestore 互換アダプター
    db = {
      collection: function (colName) {
        return {
          // 全ドキュメント取得
          get: function () {
            var data = lsRead();
            var docs = Object.keys(data).map(function (id) {
              return {
                id: id,
                data: function () { return data[id]; },
                ref: { collection: function (sub) { return db.collection(colName)._sub(id, sub); } }
              };
            });
            return Promise.resolve({ forEach: function (fn) { docs.forEach(fn); } });
          },
          // ドキュメント追加
          add: function (doc) {
            var data = lsRead();
            var id   = lsGenId();
            doc.createdAt = new Date().toISOString();
            data[id] = doc;
            data[id]._memories = {};
            lsWrite(data);
            return Promise.resolve({
              id: id,
              collection: function (sub) { return db.collection(colName)._sub(id, sub); }
            });
          },
          // 特定ドキュメント参照
          doc: function (docId) {
            return {
              collection: function (sub) { return db.collection(colName)._sub(docId, sub); },
              update: function (fields) {
                var data = lsRead();
                if (!data[docId]) return Promise.reject('doc not found');
                Object.keys(fields).forEach(function (k) {
                  data[docId][k] = fields[k];
                });
                lsWrite(data);
                return Promise.resolve();
              },
              delete: function () {
                var data = lsRead();
                delete data[docId];
                lsWrite(data);
                return Promise.resolve();
              }
            };
          },
          // サブコレクション参照（内部メソッド）
          _sub: function (parentId, subName) {
            return {
              orderBy: function () { return this; },
              get: function () {
                var data = lsRead();
                var parent = data[parentId];
                if (!parent || !parent._memories) {
                  return Promise.resolve({ forEach: function () {} });
                }
                var mems = parent._memories;
                var docs = Object.keys(mems).map(function (mId) {
                  return {
                    id: mId,
                    data: function () { return mems[mId]; }
                  };
                });
                // createdAt でソート
                docs.sort(function (a, b) {
                  return (a.data().createdAt || '') < (b.data().createdAt || '') ? -1 : 1;
                });
                return Promise.resolve({ forEach: function (fn) { docs.forEach(fn); } });
              },
              add: function (memDoc) {
                var data = lsRead();
                if (!data[parentId]) return Promise.reject('spot not found');
                var mId = lsGenId();
                memDoc.createdAt = new Date().toISOString();
                if (!data[parentId]._memories) data[parentId]._memories = {};
                data[parentId]._memories[mId] = memDoc;
                lsWrite(data);
                return Promise.resolve({ id: mId });
              },
              doc: function (memId) {
                return {
                  delete: function () {
                    var data = lsRead();
                    if (data[parentId] && data[parentId]._memories) {
                      delete data[parentId]._memories[memId];
                      lsWrite(data);
                    }
                    return Promise.resolve();
                  }
                };
              }
            };
          }
        };
      }
    };

    // Storage 互換アダプター（写真は Data URL として LocalStorage に保存）
    storage = {
      ref: function (path) {
        return {
          put: function (file) {
            return new Promise(function (resolve, reject) {
              var reader = new FileReader();
              reader.onload = function () {
                try {
                  var photos = JSON.parse(localStorage.getItem('shizugawa_photos') || '{}');
                  photos[path] = reader.result;
                  localStorage.setItem('shizugawa_photos', JSON.stringify(photos));
                  resolve();
                } catch (e) { reject(e); }
              };
              reader.onerror = function () { reject(reader.error); };
              reader.readAsDataURL(file);
            });
          },
          getDownloadURL: function () {
            var photos = JSON.parse(localStorage.getItem('shizugawa_photos') || '{}');
            return Promise.resolve(photos[path] || '');
          },
          delete: function () {
            try {
              var photos = JSON.parse(localStorage.getItem('shizugawa_photos') || '{}');
              delete photos[path];
              localStorage.setItem('shizugawa_photos', JSON.stringify(photos));
            } catch (e) {}
            return Promise.resolve();
          }
        };
      }
    };

    // firebase.firestore.FieldValue の互換
    firebase = firebase || {};
    firebase.firestore = firebase.firestore || {};
    firebase.firestore.FieldValue = {
      serverTimestamp: function () { return new Date().toISOString(); }
    };
  }

  // ==================================================
  // 定数
  // ==================================================

  // 画像マップの座標空間（CRS.Simple 用）
  var IMAGE_W      = 2000;
  var IMAGE_H      = 1400;
  var IMAGE_BOUNDS = [[0, 0], [IMAGE_H, IMAGE_W]];

  // 志津川（南三陸町）の実際の緯度経度（タイルマップ用）
  var SHIZUGAWA_CENTER = [38.676, 141.447];
  var SHIZUGAWA_ZOOM   = 15;

  // ==================================================
  // レイヤー定義
  // mode: 'simple' = CRS.Simple（画像）, 'geo' = 緯度経度（タイル）
  // ==================================================
  var LAYERS = {
    old: {
      mode:  'simple',
      url:   'image/shizugawa_map_q95.webp',
      label: '志津川なつかしマップ',
      era:   '震災前の街並みを描いたイラストマップ'
    },
    today: {
      mode:  'simple',
      url:   'image/shizugawa_today_map_q95.webp',
      label: '今の志津川マップ',
      era:   '現在の街並みを描いたイラストマップ'
    },
    osm: {
      mode:        'geo',
      url:         'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom:     19,
      label:       'OpenStreetMap',
      era:         'ボランティアにより随時更新'
    },
    'gsi-std': {
      mode:        'geo',
      url:         'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
      attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>',
      maxZoom:     18,
      label:       '国土地理院 標準地図',
      era:         '随時更新'
    },
    'gsi-photo': {
      mode:        'geo',
      url:         'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg',
      attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>',
      maxZoom:     18,
      label:       '国土地理院 航空写真',
      era:         '複数年代の空中写真を合成（地域により撮影年が異なります）'
    }
  };

  // ==================================================
  // 状態管理
  // ==================================================

  var map            = null;   // 現在の L.Map インスタンス
  var currentMode    = null;   // 'simple' | 'geo'
  var currentLayer   = null;   // 現在表示中の L.Layer
  var currentMapType = 'old';  // 'old' | 'today'

  // プレビューカードが表示されるズーム閾値
  var PREVIEW_ZOOM_THRESHOLD = 1.0;

  // スポットの純粋データ（マップ再生成でも保持される）
  var spotsData = {};

  // 現在マップ上にある L.Marker の参照（マップ再生成時に作り直す）
  var spotMarkerRefs = {};

  // ポップアップが開いているスポットのID
  var activeSpotId = null;

  // 二重送信防止
  var isSubmitting = false;

  // 新規スポット用の一時マーカー
  var tempMarker = null;

  // ピン配置中フラグ（2段階配置）
  var isPinPlacing = false;


  // ==================================================
  // 投稿パスワード認証 & モード管理
  // ながめるモード（デフォルト）/ かきこむモード
  // ==================================================
  var WRITE_PASSWORD = 'meguru';
  var isAuthed       = false;
  var isWriteMode    = false;

  // ==================================================
  // 画鋲カラーパレット
  // ==================================================
  var PIN_COLORS = [
    { id: 'red',    hex: '#FF1744', label: '商店・買い物' },
    { id: 'orange', hex: '#FF6D00', label: '食事・飲食' },
    { id: 'yellow', hex: '#FFD600', label: '学校・教育' },
    { id: 'green',  hex: '#00E676', label: '自然・公園' },
    { id: 'blue',   hex: '#2979FF', label: '公共施設' },
    { id: 'pink',   hex: '#FF4081', label: '暮らし・交流' },
    { id: 'violet', hex: '#D500F9', label: 'その他' }
  ];
  var DEFAULT_PIN_COLOR = '#FF1744';

  // ==================================================
  // マップのライフサイクル管理
  // ==================================================

  /**
   * 指定レイヤーキーでマップを初期化（または再初期化）する
   * CRS が変わる場合はマップを破棄して作り直す
   * 同じ CRS 内のレイヤー切替ではレイヤーだけ差し替える
   */
  function switchLayer(layerKey) {
    var def     = LAYERS[layerKey];
    var newMode = def.mode;

    // --- 同じ CRS 内での切替: レイヤーだけ差し替え ---
    if (map && newMode === currentMode) {
      // ピン配置中ならクリーンアップ
      cancelPinPlacement();

      if (currentLayer) map.removeLayer(currentLayer);

      if (newMode === 'simple') {
        currentLayer = L.imageOverlay(def.url, IMAGE_BOUNDS).addTo(map);
        // old / today 切替: マップタイプを更新してマーカーを再構築
        if (layerKey === 'old' || layerKey === 'today') {
          currentMapType = layerKey;
          rebuildAllMarkers();
          updateStats();
        }
      } else {
        currentLayer = L.tileLayer(def.url, {
          attribution: def.attribution,
          maxZoom:     def.maxZoom
        }).addTo(map);
      }
      return;
    }

    // --- CRS が異なる場合: マップごと作り直す ---

    // ピン配置中ならクリーンアップ
    hidePinConfirmBar();

    // 旧マップを破棄
    if (map) {
      map.remove();
      map          = null;
      currentLayer = null;
      tempMarker   = null;
      activeSpotId = null;
      spotMarkerRefs = {};
    }

    if (newMode === 'simple') {
      // old / today のマップタイプを更新
      if (layerKey === 'old' || layerKey === 'today') {
        currentMapType = layerKey;
      }

      // ---- CRS.Simple（画像マップ）----
      map = L.map('map', {
        crs:             L.CRS.Simple,
        minZoom:        -3,
        maxZoom:         4,
        zoomSnap:        0,        // 自由なズームレベル（スムーズ）
        zoomDelta:       0.5,      // ボタン / キーボードの1段階
        wheelPxPerZoomLevel: 30,   // トラックパッドでの感度（小さいほど敏感）
        wheelDebounceTime:  20,    // ホイールイベントの集約間隔（短いほど滑らか）
        zoomAnimation:   true,
        bounceAtZoomLimits: false  // 限界で跳ね返らない
      });

      currentLayer = L.imageOverlay(def.url, IMAGE_BOUNDS).addTo(map);

      // マップコンテナのサイズを確定してから画像全体にフィット
      map.invalidateSize();
      map.fitBounds(IMAGE_BOUNDS, { padding: [20, 20] });

      // ダブルクリックでズームイン（ポップアップ操作と干渉しないよう中心固定）
      map.doubleClickZoom.enable();

      // 「全体表示」ボタンを追加
      var FitControl = L.Control.extend({
        options: { position: 'topleft' },
        onAdd: function () {
          var container = L.DomUtil.create('div', 'leaflet-control-fit leaflet-bar');
          var btn = L.DomUtil.create('a', '', container);
          btn.href  = '#';
          btn.title = 'マップ全体を表示';
          btn.setAttribute('role', 'button');
          btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"><path d="M1 5V1h4M11 1h4v4M15 11v4h-4M5 15H1v-4"/></svg>';
          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.on(btn, 'click', function (e) {
            L.DomEvent.preventDefault(e);
            map.fitBounds(IMAGE_BOUNDS, { padding: [20, 20] });
          });
          return container;
        }
      });
      map.addControl(new FitControl());

      // パンやズームが終わった時、画像の外に出ていたら引き戻す
      // maxBounds と違い「壁で止まる」のではなく「スッと戻る」動きになる
      map.on('moveend', function () {
        var bounds   = map.getBounds();
        var imgBounds = L.latLngBounds(IMAGE_BOUNDS);

        // ビューが画像範囲を完全に含んでいる（ズームアウト状態）なら何もしない
        if (bounds.contains(imgBounds)) return;

        // ビューが画像範囲からはみ出していたら引き戻す
        if (!imgBounds.contains(bounds)) {
          var center = map.getCenter();
          var clamped = L.latLng(
            Math.max(imgBounds.getSouth(), Math.min(imgBounds.getNorth(), center.lat)),
            Math.max(imgBounds.getWest(),  Math.min(imgBounds.getEast(),  center.lng))
          );
          if (!center.equals(clamped)) {
            map.panTo(clamped);
          }
        }
      });

      // 保存済みマーカーを再構築
      rebuildAllMarkers();

      // クリック・ポップアップのイベントハンドラを接続
      attachMapHandlers();

      // ズームレベルに応じてプレビューカードの表示を切り替え
      (function () {
        var mapEl = document.getElementById('map');
        function updateZoomClass() {
          if (map.getZoom() >= PREVIEW_ZOOM_THRESHOLD) {
            mapEl.classList.add('zoomed-in');
          } else {
            mapEl.classList.remove('zoomed-in');
          }
        }
        map.on('zoom', updateZoomClass);
        map.on('zoomend', updateZoomClass);
        updateZoomClass();
      })();

    } else {
      // ---- 緯度経度CRS（タイルマップ）----
      map = L.map('map', {
        center: SHIZUGAWA_CENTER,
        zoom:   SHIZUGAWA_ZOOM,
        zoomSnap:              0,
        zoomDelta:             0.5,
        wheelPxPerZoomLevel:   30,
        wheelDebounceTime:     20
      });

      currentLayer = L.tileLayer(def.url, {
        attribution: def.attribution,
        maxZoom:     def.maxZoom,
        detectRetina: true
      }).addTo(map);

      // タイルマップではマーカー操作なし
    }

    currentMode = newMode;

    // 画像マップではカスタムカーソル（grab）を適用
    var mapEl = document.getElementById('map');
    if (newMode === 'simple') {
      mapEl.classList.add('mode-simple');
    } else {
      mapEl.classList.remove('mode-simple');
      mapEl.classList.remove('zoomed-in');
    }
  }

  /**
   * 保存済みマーカーにドラッグ機能を付与する
   * ドラッグ終了時に DB と spotsData の座標を更新する
   */
  function makeMarkerDraggable(marker, spotId) {
    marker.options.draggable = true;
    if (marker.dragging) marker.dragging.enable();

    marker.on('drag', function () {
      var pos = marker.getLatLng();
      var clamped = L.latLng(
        Math.max(0, Math.min(IMAGE_H, pos.lat)),
        Math.max(0, Math.min(IMAGE_W, pos.lng))
      );
      if (pos.lat !== clamped.lat || pos.lng !== clamped.lng) {
        marker.setLatLng(clamped);
      }
    });

    marker.on('dragend', function () {
      if (!isWriteMode) {
        // かきこむモード以外なら元に戻す
        var orig = spotsData[spotId].spotData;
        marker.setLatLng([orig.lat, orig.lng]);
        showToast('位置を変更するにはかきこむモードに切り替えてください', 'info');
        return;
      }

      var pos = marker.getLatLng();
      var newLat = pos.lat;
      var newLng = pos.lng;

      // メモリ上のデータを更新
      spotsData[spotId].spotData.lat = newLat;
      spotsData[spotId].spotData.lng = newLng;

      // DB を更新
      db.collection('spots').doc(spotId).update({
        lat: newLat,
        lng: newLng
      }).then(function () {
        showToast('ピンの位置を更新しました', 'success');
      }).catch(function (err) {
        console.error('位置更新失敗:', err);
        showToast('位置の更新に失敗しました', 'error');
      });
    });
  }

  /**
   * ポップアップ表示中にツールチップが重ならないよう制御する
   */
  function setupTooltipSuppression(marker) {
    marker.on('popupopen', function () {
      var tt = marker.getTooltip();
      if (tt && tt.getElement()) tt.getElement().classList.add('tooltip-suppressed');
    });
    marker.on('popupclose', function () {
      var tt = marker.getTooltip();
      if (tt && tt.getElement()) tt.getElement().classList.remove('tooltip-suppressed');
    });
    marker.on('mouseover', function () {
      var tt = marker.getTooltip();
      if (tt && tt.getElement()) tt.getElement().classList.add('spot-preview-hover');
    });
    marker.on('mouseout', function () {
      var tt = marker.getTooltip();
      if (tt && tt.getElement()) tt.getElement().classList.remove('spot-preview-hover');
    });
  }

  /**
   * spotsData から全マーカーを再構築してマップに追加する
   * CRS.Simple モード専用
   */
  function rebuildAllMarkers() {
    // 既存マーカーをマップから除去
    Object.keys(spotMarkerRefs).forEach(function (id) {
      if (spotMarkerRefs[id]) map.removeLayer(spotMarkerRefs[id]);
    });
    spotMarkerRefs = {};

    Object.keys(spotsData).forEach(function (spotId, idx) {
      var data    = spotsData[spotId];
      var mapType = data.spotData.mapType || 'old';
      if (mapType !== currentMapType) return;  // 現在のマップタイプのみ表示

      var icon   = createMemoryIcon(data.spotData.pinColor, data.memories.length);
      var marker = L.marker([data.spotData.lat, data.spotData.lng], { icon: icon }).addTo(map);

      marker.bindPopup(
        buildSpotPopupHtml(spotId, data.memories),
        { maxWidth: 350, minWidth: 290 }
      );
      marker.bindTooltip(buildSpotTooltipHtml(spotId, data.memories), {
        permanent: true, interactive: false, direction: 'top', offset: [0, -6], opacity: 1, className: 'spot-preview'
      });

      // ドラッグで位置調整を可能にする
      makeMarkerDraggable(marker, spotId);
      setupTooltipSuppression(marker);

      // ふわっと出現アニメーション
      animateMarkerDrop(marker);

      spotMarkerRefs[spotId] = marker;
    });
  }

  // ==================================================
  // 思い出モード — モーダル制御
  // ==================================================
  var memoryOverlay = document.getElementById('memory-overlay');
  var modalBody     = document.getElementById('modal-body');
  var modalFooter   = document.getElementById('modal-footer');

  /**
   * モーダルを開く
   * @param {string} html - モーダル内に表示する HTML
   * @param {string} [footerHtml] - フッターに表示するボタン等の HTML
   */
  function openMemoryModal(html, footerHtml) {
    modalBody.innerHTML = html;
    modalFooter.innerHTML = footerHtml || '';
    modalFooter.style.display = footerHtml ? '' : 'none';
    memoryOverlay.classList.add('active');
    // 少し遅延してフォーカス
    setTimeout(function () {
      var firstInput = modalBody.querySelector('input[type="text"], input[type="password"], textarea');
      if (firstInput) firstInput.focus();
    }, 100);
  }

  /**
   * モーダルを閉じる（アニメーション付き）
   */
  function closeMemoryModal() {
    memoryOverlay.classList.remove('active');
    setTimeout(function () {
      modalBody.innerHTML = '';
      modalFooter.innerHTML = '';
      modalFooter.style.display = 'none';
      // 一時マーカーがあれば除去
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
    }, 350);
  }

  // 閉じるボタン
  document.getElementById('modal-close-btn').addEventListener('click', closeMemoryModal);

  // 背景クリックで閉じる
  memoryOverlay.querySelector('.overlay-backdrop').addEventListener('click', function () {
    if (!isSubmitting) closeMemoryModal();
  });

  // ==================================================
  // モード切替（ながめる ↔ かきこむ）
  // ==================================================
  function updateHelpForMode() {
    var viewSection  = document.getElementById('help-view');
    var writeSection = document.getElementById('help-write');
    if (viewSection)  viewSection.style.display  = isWriteMode ? 'none' : '';
    if (writeSection) writeSection.style.display = isWriteMode ? '' : 'none';
  }

  function enterWriteMode() {
    isWriteMode = true;
    var btn   = document.getElementById('btn-mode-toggle');
    var label = document.getElementById('mode-label');
    if (btn)   { btn.className = 'mode-write'; btn.title = 'ながめるモードに切り替え'; }
    if (label) label.textContent = 'ながめる';
    updateHelpForMode();

    // 全マーカーのポップアップ・ツールチップを再構築
    Object.keys(spotsData).forEach(function (spotId) {
      var marker = spotMarkerRefs[spotId];
      if (marker) {
        marker.setPopupContent(buildSpotPopupHtml(spotId, spotsData[spotId].memories));
        marker.setTooltipContent(buildSpotTooltipHtml(spotId, spotsData[spotId].memories));
      }
    });
  }

  function exitWriteMode() {
    isWriteMode = false;
    // ピン配置中ならキャンセル
    if (isPinPlacing) cancelPinPlacement();

    var btn   = document.getElementById('btn-mode-toggle');
    var label = document.getElementById('mode-label');
    if (btn)   { btn.className = 'mode-view'; btn.title = 'かきこむモードに切り替え'; }
    if (label) label.textContent = 'かきこむ';
    updateHelpForMode();

    // 全マーカーのポップアップ・ツールチップを再構築（編集UIを非表示に）
    Object.keys(spotsData).forEach(function (spotId) {
      var marker = spotMarkerRefs[spotId];
      if (marker) {
        marker.setPopupContent(buildSpotPopupHtml(spotId, spotsData[spotId].memories));
        marker.setTooltipContent(buildSpotTooltipHtml(spotId, spotsData[spotId].memories));
      }
    });
  }

  // モード切替ボタン
  document.getElementById('btn-mode-toggle').addEventListener('click', function () {
    if (isWriteMode) {
      exitWriteMode();
      return;
    }
    // かきこむモードへ：未認証ならパスワード、認証済みなら即切替
    if (isAuthed) {
      enterWriteMode();
    } else {
      openMemoryModal(buildAuthFormHtml());
    }
  });

  // Escape キーで閉じる（ピン配置中はキャンセル）
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      if (isPinPlacing) {
        cancelPinPlacement();
        return;
      }
      if (memoryOverlay.classList.contains('active') && !isSubmitting) {
        closeMemoryModal();
      }
    }
  });

  // ==================================================
  // 2段階ピン配置
  // ==================================================

  /**
   * 指定座標にドラッグ可能な仮ピンを配置し確認バーを表示する
   */
  function placeTempPin(latlng) {
    if (tempMarker) {
      map.removeLayer(tempMarker);
    }

    tempMarker = L.marker(latlng, {
      draggable: true,
      icon: createTempIcon()
    }).addTo(map);
    tempMarker._latlng = latlng;
    tempMarker._pendingLatLng = latlng;

    // ドロップアニメーション
    animateMarkerDrop(tempMarker);

    // ドラッグ中に画像範囲外へ出ないようにクランプ
    tempMarker.on('drag', function () {
      var pos = tempMarker.getLatLng();
      var clamped = L.latLng(
        Math.max(0, Math.min(IMAGE_H, pos.lat)),
        Math.max(0, Math.min(IMAGE_W, pos.lng))
      );
      if (pos.lat !== clamped.lat || pos.lng !== clamped.lng) {
        tempMarker.setLatLng(clamped);
      }
    });

    // ドラッグ終了で座標を更新
    tempMarker.on('dragend', function () {
      var pos = tempMarker.getLatLng();
      tempMarker._latlng = pos;
      tempMarker._pendingLatLng = pos;
    });

    showPinConfirmBar();
  }

  /**
   * 配置中ピン用のアイコン（青・パルス付き）
   */
  function createTempIcon() {
    var html = '<div class="pin-marker pin-placing">' +
      '<div class="pin-head" style="background:#3B82F6;"></div>' +
    '</div>';
    return L.divIcon({
      className: '',
      html: html,
      iconSize:   [4, 4],
      iconAnchor: [2, 2],
      popupAnchor: [0, -4]
    });
  }

  /**
   * 確認バーを表示する
   */
  function showPinConfirmBar() {
    isPinPlacing = true;
    var bar = document.getElementById('pin-confirm-bar');
    if (bar) bar.classList.add('active');
  }

  /**
   * 確認バーを非表示にする
   */
  function hidePinConfirmBar() {
    isPinPlacing = false;
    var bar = document.getElementById('pin-confirm-bar');
    if (bar) bar.classList.remove('active');
  }

  /**
   * ピン位置を確定して入力画面へ進む
   */
  function confirmPinPosition() {
    if (!tempMarker) return;
    hidePinConfirmBar();

    // ドラッグ無効化
    if (tempMarker.dragging) tempMarker.dragging.disable();

    // パルスを止めた通常ピンアイコンに切り替え
    tempMarker.setIcon(L.divIcon({
      className: '',
      html: '<div class="pin-marker"><div class="pin-head" style="background:#3B82F6;"></div></div>',
      iconSize:   [7, 7],
      iconAnchor: [3, 3],
      popupAnchor: [0, -6]
    }));

    // 確定座標を更新
    var latlng = tempMarker.getLatLng();
    tempMarker._latlng = latlng;
    tempMarker._pendingLatLng = latlng;

    // モーダル表示（かきこむモード中なので常にフォーム）
    openMemoryModal(
      buildNewSpotFormHtml(latlng),
      '<button class="submit-btn" id="btn-submit-new">ピンを保存する</button>'
    );
  }

  /**
   * ピン配置をキャンセルする
   */
  function cancelPinPlacement() {
    hidePinConfirmBar();
    if (tempMarker) {
      map.removeLayer(tempMarker);
      tempMarker = null;
    }
  }

  // 確認バーのボタンイベント
  document.getElementById('btn-pin-confirm').addEventListener('click', confirmPinPosition);
  document.getElementById('btn-pin-cancel').addEventListener('click', cancelPinPlacement);

  function attachMapHandlers() {
    // マップクリック → ドラッグ可能な仮ピンを配置（2段階フロー）
    map.on('click', function (e) {
      if (!isWriteMode) return;
      if (isSubmitting) return;
      if (isPinPlacing) return;
      if (memoryOverlay.classList.contains('active')) return;

      // 画像の外側はピンを置けない
      var imgBounds = L.latLngBounds(IMAGE_BOUNDS);
      if (!imgBounds.contains(e.latlng)) return;

      // リップルエフェクト
      showRipple(e);

      // 共通処理でピン配置
      placeTempPin(e.latlng);
    });

    // ポップアップの開閉で activeSpotId を追跡
    map.on('popupopen', function (e) {
      var el = e.popup.getElement();
      if (!el) return;
      var spotEl = el.querySelector('.spot-popup[data-spot-id]');
      if (spotEl) activeSpotId = spotEl.getAttribute('data-spot-id');
    });

    map.on('popupclose', function () {
      activeSpotId = null;
    });

  }

  // ==================================================
  // ユーティリティ
  // ==================================================

  /**
   * トースト通知を表示する（alert の代替）
   * @param {string} msg - メッセージ
   * @param {'success'|'error'|'info'} type
   */
  function showToast(msg, type) {
    type = type || 'info';
    var container = document.getElementById('toast-container');
    var el = document.createElement('div');
    el.className = 'toast toast-' + type;
    el.textContent = msg;
    container.appendChild(el);
    setTimeout(function () {
      el.classList.add('hide');
      el.addEventListener('animationend', function () { el.remove(); });
    }, 2600);
  }

  /**
   * ステータスバーの数字を更新する
   */
  function updateStats() {
    var spotCount   = 0;
    var memoryCount = 0;
    Object.keys(spotsData).forEach(function (id) {
      var mapType = spotsData[id].spotData.mapType || 'old';
      if (mapType !== currentMapType) return;
      spotCount++;
      memoryCount += spotsData[id].memories.length;
    });
    var spotsEl = document.getElementById('stat-spots');
    var memsEl  = document.getElementById('stat-memories');
    if (spotsEl)  spotsEl.textContent = spotCount;
    if (memsEl)   memsEl.textContent  = memoryCount;
  }

  /**
   * クリック位置にリップルエフェクトを表示する
   */
  function showRipple(e) {
    var point = map.latLngToContainerPoint(e.latlng);
    var ripple = document.createElement('div');
    ripple.className = 'map-ripple';
    ripple.style.left = point.x + 'px';
    ripple.style.top  = point.y + 'px';
    var mapEl = document.getElementById('map');
    mapEl.appendChild(ripple);
    ripple.addEventListener('animationend', function () { ripple.remove(); });
  }

  /**
   * マーカーにふわっと出現アニメーションを付与する
   */
  function animateMarkerDrop(marker) {
    var el = marker.getElement ? marker.getElement() : null;
    if (el) {
      el.classList.add('marker-drop');
      el.addEventListener('animationend', function () {
        el.classList.remove('marker-drop');
      }, { once: true });
    }
  }

  /**
   * 画鋲マーカーアイコンを生成する
   * @param {string} color - ピンの色（hex）
   * @param {number} count - 思い出の数
   */
  function createMemoryIcon(color, count) {
    color = color || DEFAULT_PIN_COLOR;

    var badge = count > 1
      ? '<span class="pin-badge">' + count + '</span>'
      : '';

    var html = '<div class="pin-marker" style="--pin-color:' + color + ';">' +
      '<div class="pin-glow"></div>' +
      '<div class="pin-head" style="background:' + color + ';"></div>' +
      badge +
    '</div>';

    return L.divIcon({
      className: '',
      html: html,
      iconSize:   [4, 4],
      iconAnchor: [2, 2],
      popupAnchor: [0, -4]
    });
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str || ''));
    return div.innerHTML;
  }

  function formatDate(timestamp) {
    if (!timestamp) return '';
    var date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('ja-JP', {
      year: 'numeric', month: 'long', day: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
  }

  // ==================================================
  // ポップアップ HTML 生成
  // ==================================================

  /**
   * パスワード入力フォーム（投稿認証用）
   */
  function buildAuthFormHtml() {
    return '' +
      '<div class="auth-form">' +
        '<h3>投稿パスワード</h3>' +
        '<p>思い出を書き込むにはパスワードが必要です</p>' +
        '<input type="password" id="input-auth-pw" placeholder="パスワードを入力">' +
        '<div class="auth-error" id="auth-error">パスワードが違います</div>' +
        '<button class="submit-btn" id="btn-auth-submit">認証する</button>' +
      '</div>';
  }

  /**
   * 認証成功時の処理
   */
  function onAuthSuccess() {
    isAuthed = true;
    enterWriteMode();
    showToast('認証しました。かきこむモードになりました', 'success');
  }

  /**
   * 新規スポット作成用フォーム
   * @param {L.LatLng} latlng - クリックされたピクセル座標
   */
  function buildNewSpotFormHtml(latlng) {
    // 色パレットを生成
    var colorHtml = '<div class="color-picker" id="color-picker">';
    PIN_COLORS.forEach(function (c, i) {
      var sel = i === 0 ? ' selected' : '';
      colorHtml += '<div class="color-option' + sel + '" data-color="' + c.hex + '">' +
        '<span class="color-dot" style="background:' + c.hex + ';"></span>' +
        '<span class="color-label">' + c.label + '</span>' +
      '</div>';
    });
    colorHtml += '</div>';

    return '' +
      '<div class="memory-form">' +
        '<h3>思い出を残す</h3>' +
        '<label>カテゴリ</label>' +
        colorHtml +
        '<label for="input-place">場所の名前</label>' +
        '<input type="text" id="input-place" placeholder="例: 高野会館、荒島、魚市場...">' +
        '<label for="input-name">お名前</label>' +
        '<input type="text" id="input-name" placeholder="お名前を入力">' +
        '<label for="input-era">いつごろの思い出？</label>' +
        '<input type="text" id="input-era" placeholder="例: 昭和50年ごろ、震災前、2020年…">' +
        '<label for="input-memory">思い出</label>' +
        '<textarea id="input-memory" placeholder="この場所の思い出を書いてください"></textarea>' +
        '<label for="input-photo">当時の写真</label>' +
        '<input type="file" id="input-photo" accept="image/*">' +
        '<img class="photo-preview" id="photo-preview">' +
      '</div>';
  }

  /**
   * 既存スポットへの追加投稿フォーム（モーダル用）
   */
  function buildAddMemoryFormHtml() {
    var pName = '';
    if (activeSpotId && spotsData[activeSpotId]) {
      pName = spotsData[activeSpotId].spotData.placeName || '';
    }
    var title = pName ? escapeHtml(pName) + ' に思い出を追加' : '思い出を追加';
    return '' +
      '<div class="memory-form">' +
        '<h3>' + title + '</h3>' +
        '<label for="input-name">お名前</label>' +
        '<input type="text" id="input-name" placeholder="お名前を入力">' +
        '<label for="input-era">いつごろの思い出？</label>' +
        '<input type="text" id="input-era" placeholder="例: 昭和50年ごろ、震災前、2020年…">' +
        '<label for="input-memory">思い出</label>' +
        '<textarea id="input-memory" placeholder="この場所の思い出を書いてください"></textarea>' +
        '<label for="input-photo">当時の写真</label>' +
        '<input type="file" id="input-photo" accept="image/*">' +
        '<img class="photo-preview" id="photo-preview">' +
      '</div>';
  }

  /**
   * hex から PIN_COLORS のラベルを引く
   */
  function pinColorLabel(hex) {
    for (var i = 0; i < PIN_COLORS.length; i++) {
      if (PIN_COLORS[i].hex === hex) return PIN_COLORS[i].label;
    }
    return '';
  }

  /** ホバー時に表示するツールチップ（コンパクトプレビュー） */
  function buildSpotTooltipHtml(spotId, memories) {
    var spot = spotsData[spotId];
    var pName = spot ? (spot.spotData.placeName || 'この場所') : 'この場所';
    var catLabel = spot ? pinColorLabel(spot.spotData.pinColor) : '';
    var catColor = spot ? spot.spotData.pinColor : '';

    var h = '<div class="spot-tt-inner">';
    h += '<div class="spot-tt-header">';
    h += '<span class="spot-tt-name">' + escapeHtml(pName) + '</span>';
    if (catLabel) {
      h += '<span class="spot-tt-cat" style="color:' + escapeHtml(catColor) + ';">' + escapeHtml(catLabel) + '</span>';
    }
    h += '</div>';

    if (memories.length > 0) {
      var first = memories[0];
      if (first.era) {
        h += '<div class="spot-tt-era">' + escapeHtml(first.era) + '</div>';
      }
      if (first.memory) {
        var text = first.memory.length > 40 ? first.memory.substring(0, 40) + '…' : first.memory;
        h += '<div class="spot-tt-text">' + escapeHtml(text) + '</div>';
      }
      if (first.photoURL) {
        h += '<img class="spot-tt-photo" src="' + escapeHtml(first.photoURL) + '" alt="">';
      }
      if (memories.length > 1) {
        h += '<div class="spot-tt-more">他 ' + (memories.length - 1) + ' 件の思い出</div>';
      }
    } else {
      h += '<div class="spot-tt-empty">まだ思い出がありません</div>';
    }

    h += '</div>';
    return h;
  }

  /** 既存スポットのポップアップ（思い出一覧 + 追加フォーム） */
  function buildSpotPopupHtml(spotId, memories) {
    var n = memories.length;

    var spot = spotsData[spotId];

    var h = '<div class="spot-popup" data-spot-id="' + escapeHtml(spotId) + '">';

    // ヘッダー
    var pName = spot ? (spot.spotData.placeName || 'この場所') : 'この場所';
    var catLabel = spot ? pinColorLabel(spot.spotData.pinColor) : '';
    h += '<div class="spot-header">' +
           '<h3>' + escapeHtml(pName) + '</h3>' +
           (isWriteMode ? '<button class="rename-btn" data-spot-id="' + escapeHtml(spotId) + '" title="名前を変更">&#x270E;</button>' : '') +
           (catLabel ? '<span class="spot-category" style="color:' + escapeHtml(spot.spotData.pinColor) + ';">' + escapeHtml(catLabel) + '</span>' : '') +
           (n > 0 ? '<span class="memory-count">(' + n + '件)</span>' : '') +
         '</div>';

    // カテゴリ変更ボタン（かきこむモードのみ）
    if (isWriteMode) {
      h += '<div class="spot-color-picker">';
      PIN_COLORS.forEach(function (c) {
        var sel = (spot && spot.spotData.pinColor === c.hex) ? ' selected' : '';
        h += '<span class="spot-color-btn' + sel + '" data-spot-id="' + escapeHtml(spotId) + '" data-color="' + c.hex + '" title="' + c.label + '">' +
               '<span class="color-dot" style="background:' + c.hex + ';"></span>' +
             '</span>';
      });
      h += '</div>';
    }

    // 思い出一覧（スクロール）
    if (n > 0) {
      h += '<div class="memories-list">';
      memories.forEach(function (m) {
        h += '<div class="memory-item">';
        if (m.name) {
          h += '<div class="saved-name">' + escapeHtml(m.name) + ' さん</div>';
        }
        if (m.era) {
          h += '<div class="saved-era">' + escapeHtml(m.era) + '</div>';
        }
        if (m.memory) {
          h += '<div class="saved-memory">' + escapeHtml(m.memory) + '</div>';
        }
        if (m.photoURL) {
          h += '<div class="saved-photo-wrap">';
          h += '<img class="saved-photo" src="' + escapeHtml(m.photoURL) + '" alt="当時の写真">';
          if (isWriteMode) {
            h += '<button class="photo-delete-btn" ' +
                   'data-spot-id="'    + escapeHtml(spotId) + '" ' +
                   'data-memory-id="'  + escapeHtml(m.docId) + '" ' +
                   'data-photo-path="' + escapeHtml(m.photoPath || '') + '"' +
                   '>&times; 写真を削除</button>';
          }
          h += '</div>';
        }
        h +=   '<div class="saved-date">' + escapeHtml(formatDate(m.createdAt)) + '</div>';
        if (isWriteMode) {
          h += '<div class="memory-actions">' +
                 '<button class="edit-btn" ' +
                   'data-spot-id="'   + escapeHtml(spotId) + '" ' +
                   'data-memory-id="' + escapeHtml(m.docId) + '">' +
                   '&#x270E; この思い出を編集</button>' +
                 '<button class="delete-btn" ' +
                   'data-spot-id="'    + escapeHtml(spotId) + '" ' +
                   'data-memory-id="'  + escapeHtml(m.docId) + '" ' +
                   'data-photo-path="' + escapeHtml(m.photoPath || '') + '">' +
                   '&#x2715; この思い出を削除</button>' +
               '</div>';
        }
        h += '</div>';
      });
      h += '</div>';
    } else {
      h += '<div style="padding:8px 0;font-size:12px;color:#999;">まだ思い出が書かれていません</div>';
    }

    // 追加ボタン（かきこむモードのみ表示）
    if (isWriteMode) {
      h += '<button class="add-toggle-btn" id="btn-toggle-form">この場所に思い出を追加する</button>';
    }

    h += '</div>';
    return h;
  }

  // ==================================================
  // 写真アップロード・フォーム値取得ヘルパー
  // ==================================================

  function uploadPhoto(file) {
    if (!file) return Promise.resolve({ photoURL: '', photoPath: '' });
    var path = 'memories/' + Date.now() + '_' + file.name;
    var ref  = storage.ref(path);
    return ref.put(file)
      .then(function () { return ref.getDownloadURL(); })
      .then(function (url) { return { photoURL: url, photoPath: path }; });
  }

  function getFormValues() {
    var pl = document.getElementById('input-place');
    var n  = document.getElementById('input-name');
    var er = document.getElementById('input-era');
    var m  = document.getElementById('input-memory');
    var p  = document.getElementById('input-photo');
    // 選択中の色を取得
    var selectedOption = document.querySelector('#color-picker .color-option.selected');
    var pinColor = selectedOption ? selectedOption.getAttribute('data-color') : DEFAULT_PIN_COLOR;
    return {
      placeName: pl ? pl.value.trim() : '',
      pinColor:  pinColor,
      name:      n  ? n.value.trim()  : '',
      era:       er ? er.value.trim() : '',
      memory:    m  ? m.value.trim()  : '',
      photo:     (p && p.files.length > 0) ? p.files[0] : null
    };
  }

  // ==================================================
  // 初回起動: スプラッシュ → 街全体を見渡す状態で開始
  // ==================================================

  // ① マップを生成（スプラッシュの裏で準備）
  switchLayer('old');

  // スプラッシュ中はツールチップも隠す
  document.getElementById('map').classList.add('markers-hidden');

  // ② スプラッシュ中はパネルを隠す
  var mapToggleEl = document.getElementById('map-toggle');
  mapToggleEl.style.opacity    = '0';
  mapToggleEl.style.transition = 'opacity 0.6s ease';

  var layerPanel = document.getElementById('layer-panel');
  layerPanel.style.opacity    = '0';
  layerPanel.style.transition = 'opacity 0.6s ease';

  var helpPanel = document.getElementById('help-panel');
  helpPanel.style.opacity    = '0';
  helpPanel.style.transition = 'opacity 0.6s ease';

  var contactPanel = document.getElementById('contact-panel');
  contactPanel.style.opacity    = '0';
  contactPanel.style.transition = 'opacity 0.6s ease';

  var aboutBtn = document.getElementById('btn-about');
  aboutBtn.style.opacity    = '0';
  aboutBtn.style.transition = 'opacity 0.6s ease';

  var albumBtn = document.getElementById('btn-album');
  albumBtn.style.opacity    = '0';
  albumBtn.style.transition = 'opacity 0.6s ease';

  var modeToggle = document.getElementById('mode-toggle');
  modeToggle.style.opacity    = '0';
  modeToggle.style.transition = 'opacity 0.6s ease';

  // ③ スプラッシュ → フェードアウト → 街全体がそのまま見える
  var SPLASH_DURATION = 6500;
  var splashDone = false;

  /** スプラッシュ後に全マーカーを同時にふわっと表示する */
  function animateAllMarkersEntrance() {
    var ids = Object.keys(spotMarkerRefs);
    ids.forEach(function (spotId) {
      var marker = spotMarkerRefs[spotId];
      var el = marker.getElement ? marker.getElement() : null;
      if (!el) return;
      el.classList.remove('marker-hidden');
      animateMarkerDrop(marker);
    });
  }

  setTimeout(function () {
    var splash = document.getElementById('splash');
    splash.classList.add('hide');

    // スプラッシュが消えたらマップ全体を再フィット（サイズ確定後）
    setTimeout(function () {
      mapToggleEl.style.opacity  = '1';
      layerPanel.style.opacity   = '1';
      helpPanel.style.opacity    = '1';
      contactPanel.style.opacity = '1';
      aboutBtn.style.opacity     = '1';
      modeToggle.style.opacity   = '1';
      albumBtn.style.opacity     = '1';
      if (map && currentMode === 'simple') {
        map.invalidateSize();
        map.fitBounds(IMAGE_BOUNDS, { padding: [20, 20] });
      }
      // スプラッシュ終了 → ピンを降らせる
      splashDone = true;
      document.getElementById('map').classList.remove('markers-hidden');
      animateAllMarkersEntrance();

    }, 400);

    // スプラッシュのDOMを除去
    splash.addEventListener('transitionend', function () {
      splash.remove();
    });
  }, SPLASH_DURATION);

  // ==================================================
  // Firestore からスポット＆思い出を読み込み
  //
  // Firestore 構造:
  //   spots/{spotId}               → { lat, lng, createdAt }
  //   spots/{spotId}/memories/{id} → { name, memory, photoURL, photoPath, createdAt }
  // ==================================================
  (function loadAllSpots() {
    db.collection('spots').get()
      .then(function (spotsSnap) {
        var tasks = [];
        spotsSnap.forEach(function (spotDoc) {
          var task = spotDoc.ref.collection('memories')
            .orderBy('createdAt', 'asc')
            .get()
            .then(function (memSnap) {
              var memories = [];
              memSnap.forEach(function (mDoc) {
                var d   = mDoc.data();
                d.docId = mDoc.id;
                memories.push(d);
              });
              return { spotId: spotDoc.id, spotData: spotDoc.data(), memories: memories };
            });
          tasks.push(task);
        });
        return Promise.all(tasks);
      })
      .then(function (results) {
        results.forEach(function (r) {
          // データストアに格納
          var spotMapType = r.spotData.mapType || 'old';
          spotsData[r.spotId] = {
            spotData: { lat: r.spotData.lat, lng: r.spotData.lng, placeName: r.spotData.placeName || '', pinColor: r.spotData.pinColor || DEFAULT_PIN_COLOR, mapType: spotMapType },
            memories: r.memories
          };

          // 現在 CRS.Simple かつ同じマップタイプなら即座にマーカーを追加
          if (currentMode === 'simple' && spotMapType === currentMapType) {
            var icon = createMemoryIcon(r.spotData.pinColor, r.memories.length);
            var marker = L.marker([r.spotData.lat, r.spotData.lng], { icon: icon }).addTo(map);
            marker.bindPopup(
              buildSpotPopupHtml(r.spotId, r.memories),
              { maxWidth: 350, minWidth: 290 }
            );
            marker.bindTooltip(buildSpotTooltipHtml(r.spotId, r.memories), {
              permanent: true, interactive: false, direction: 'top', offset: [0, -6], opacity: 1, className: 'spot-preview'
            });
            makeMarkerDraggable(marker, r.spotId);
            setupTooltipSuppression(marker);
            // スプラッシュ中は隠す（後でまとめてアニメーション）
            // スプラッシュ後なら即アニメーション
            if (!splashDone) {
              (function(m) {
                setTimeout(function() {
                  var el = m.getElement ? m.getElement() : null;
                  if (el) el.classList.add('marker-hidden');
                }, 0);
              })(marker);
            } else {
              animateMarkerDrop(marker);
            }
            spotMarkerRefs[r.spotId] = marker;
          }
        });
        updateStats();
        console.log(results.length + ' 件のスポットを復元しました');
      })
      .catch(function (err) {
        console.error('Firestoreの読み込みに失敗:', err);
      });
  })();

  // ==================================================
  // なつかし / いま トグルボタン
  // ==================================================
  document.getElementById('map-toggle').addEventListener('click', function (e) {
    var btn = e.target.closest('.map-toggle-btn');
    if (!btn) return;
    var mapKey = btn.getAttribute('data-map');
    if (mapKey === currentMapType && currentMode === 'simple') return; // 既に選択中

    // ボタンの active クラスを切替
    var btns = document.querySelectorAll('.map-toggle-btn');
    for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
    btn.classList.add('active');

    // レイヤーパネルのラジオを解除（参考地図から戻る場合）
    var radios = document.querySelectorAll('#layer-body input[name="layer"]');
    for (var j = 0; j < radios.length; j++) radios[j].checked = false;
    document.getElementById('tile-note').style.display = 'none';

    switchLayer(mapKey);
  });

  // ==================================================
  // レイヤーパネルの操作
  // ==================================================

  // トグルボタンで開閉
  var layerToggle = document.getElementById('layer-toggle');
  var layerBody   = document.getElementById('layer-body');

  layerToggle.addEventListener('click', function (e) {
    e.stopPropagation();
    layerBody.classList.toggle('open');
  });

  // パネル外をクリックしたら閉じる
  document.addEventListener('click', function (e) {
    if (!document.getElementById('layer-panel').contains(e.target)) {
      layerBody.classList.remove('open');
    }
  });

  // レイヤー変更
  document.getElementById('layer-panel').addEventListener('change', function (e) {
    if (e.target.name !== 'layer') return;

    var key = e.target.value;
    var def = LAYERS[key];

    switchLayer(key);

    // タイルマップ時は注意書きを表示
    document.getElementById('tile-note').style.display =
      def.mode === 'geo' ? 'block' : 'none';

    // 選んだらパネルを閉じる
    layerBody.classList.remove('open');
  });

  // ==================================================
  // このサイトについてオーバーレイの操作
  // ==================================================
  var aboutOverlay = document.getElementById('about-overlay');

  document.getElementById('btn-about').addEventListener('click', function () {
    aboutOverlay.classList.add('active');
  });

  function closeAboutOverlay() {
    aboutOverlay.classList.remove('active');
  }

  document.getElementById('about-close-btn').addEventListener('click', closeAboutOverlay);
  aboutOverlay.querySelector('.overlay-backdrop').addEventListener('click', closeAboutOverlay);

  // ==================================================
  // ヘルプパネルの操作
  // ==================================================
  var helpToggle = document.getElementById('help-toggle');
  var helpBody   = document.getElementById('help-body');

  helpToggle.addEventListener('click', function (e) {
    e.stopPropagation();
    helpBody.classList.toggle('open');
  });

  // パネル外をクリックしたら閉じる
  document.addEventListener('click', function (e) {
    if (!document.getElementById('help-panel').contains(e.target)) {
      helpBody.classList.remove('open');
    }
  });

  // ==================================================
  // イベント委譲: ポップアップ内の全操作
  // document 上で捕捉するためマップ再生成の影響を受けない
  // ==================================================
  document.addEventListener('click', function (e) {
    var t = e.target;
    if (!t) return;

    // ===== カラーカテゴリ選択（フォーム内） =====
    var colorOption = t.closest('.color-option');
    if (colorOption) {
      var picker = colorOption.closest('.color-picker');
      if (picker) {
        var options = picker.querySelectorAll('.color-option');
        for (var i = 0; i < options.length; i++) {
          options[i].classList.remove('selected');
        }
        colorOption.classList.add('selected');
      }
      return;
    }

    // ===== スポット名変更（ポップアップ内） =====
    if (t.closest('.rename-btn')) {
      var renameBtn = t.closest('.rename-btn');
      var spotId = renameBtn.getAttribute('data-spot-id');
      if (!spotId || !isWriteMode) return;

      var popup = renameBtn.closest('.spot-popup');
      var header = popup ? popup.querySelector('.spot-header') : null;
      if (!header) return;

      var currentName = spotsData[spotId].spotData.placeName || '';
      header.innerHTML =
        '<div class="rename-inline">' +
          '<input type="text" id="input-rename" value="' + escapeHtml(currentName) + '" placeholder="スポット名を入力">' +
          '<button id="btn-rename-save" data-spot-id="' + escapeHtml(spotId) + '">変更</button>' +
        '</div>';

      var inp = document.getElementById('input-rename');
      if (inp) { inp.focus(); inp.select(); }
      return;
    }

    if (t.id === 'btn-rename-save') {
      var spotId = t.getAttribute('data-spot-id');
      var inp = document.getElementById('input-rename');
      var newName = inp ? inp.value.trim() : '';
      if (!spotId || !newName || !isWriteMode) return;

      spotsData[spotId].spotData.placeName = newName;
      var marker = spotMarkerRefs[spotId];
      if (marker) {
        marker.setPopupContent(buildSpotPopupHtml(spotId, spotsData[spotId].memories));
        marker.setTooltipContent(buildSpotTooltipHtml(spotId, spotsData[spotId].memories));
        marker.getPopup().update();
      }

      db.collection('spots').doc(spotId).update({ placeName: newName })
        .then(function () {
          showToast('スポット名を変更しました', 'success');
        })
        .catch(function (err) {
          console.error('名前変更失敗:', err);
          showToast('名前の変更に失敗しました', 'error');
        });
      return;
    }

    // ===== カテゴリ変更（ポップアップ内） =====
    var colorBtn = t.closest('.spot-color-btn');
    if (colorBtn) {
      var spotId   = colorBtn.getAttribute('data-spot-id');
      var newColor = colorBtn.getAttribute('data-color');
      if (!spotId || !newColor || !isWriteMode) return;

      // UI 即時更新
      var container = colorBtn.parentElement;
      if (container) {
        var btns = container.querySelectorAll('.spot-color-btn');
        for (var i = 0; i < btns.length; i++) { btns[i].classList.remove('selected'); }
        colorBtn.classList.add('selected');
      }

      // データ更新
      spotsData[spotId].spotData.pinColor = newColor;
      var marker = spotMarkerRefs[spotId];
      if (marker) {
        marker.setIcon(createMemoryIcon(newColor, spotsData[spotId].memories.length));
        marker.setPopupContent(buildSpotPopupHtml(spotId, spotsData[spotId].memories));
        marker.setTooltipContent(buildSpotTooltipHtml(spotId, spotsData[spotId].memories));
      }

      // DB 保存
      db.collection('spots').doc(spotId).update({ pinColor: newColor })
        .then(function () {
          showToast('カテゴリを変更しました', 'success');
        })
        .catch(function (err) {
          console.error('カテゴリ変更失敗:', err);
          showToast('カテゴリの変更に失敗しました', 'error');
        });
      return;
    }

    // ===== 0. パスワード認証 =====
    if (t.id === 'btn-auth-submit') {
      e.preventDefault();
      var pwInput = document.getElementById('input-auth-pw');
      var errEl   = document.getElementById('auth-error');
      if (!pwInput) return;

      if (pwInput.value === WRITE_PASSWORD) {
        onAuthSuccess();
        // 認証完了 → モーダルを閉じてかきこむモードへ
        if (memoryOverlay.classList.contains('active')) {
          closeMemoryModal();
        }
      } else {
        // 認証失敗
        if (errEl) errEl.style.display = 'block';
        pwInput.value = '';
        pwInput.focus();
      }
      return;
    }

    // ===== 1. 新規スポット作成 =====
    if (t.id === 'btn-submit-new') {
      e.preventDefault();
      if (isSubmitting || !tempMarker) return;

      var vals = getFormValues();
      var hasMemory = vals.name || vals.memory || vals.photo;

      var latlng = tempMarker._latlng;
      isSubmitting       = true;
      t.disabled         = true;
      t.textContent      = '保存中...';

      var photoPromise = hasMemory ? uploadPhoto(vals.photo) : Promise.resolve({ photoURL: '', photoPath: '' });

      photoPromise
        .then(function (photo) {
          // ① spots ドキュメントを作成
          return db.collection('spots').add({
            lat: latlng.lat, lng: latlng.lng,
            placeName: vals.placeName,
            pinColor: vals.pinColor,
            mapType: currentMapType,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          }).then(function (spotRef) {
            var result = {
              spotId:   spotRef.id,
              spotData: { lat: latlng.lat, lng: latlng.lng, placeName: vals.placeName, pinColor: vals.pinColor, mapType: currentMapType },
              mem: null
            };

            // ② 思い出がある場合のみサブコレクションに追加
            if (hasMemory) {
              return spotRef.collection('memories').add({
                name: vals.name, memory: vals.memory, era: vals.era,
                photoURL: photo.photoURL, photoPath: photo.photoPath,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              }).then(function (memRef) {
                result.mem = {
                  docId: memRef.id, name: vals.name, memory: vals.memory, era: vals.era,
                  photoURL: photo.photoURL, photoPath: photo.photoPath,
                  createdAt: new Date()
                };
                return result;
              });
            }
            return result;
          });
        })
        .then(function (res) {
          var savedTempMarker = tempMarker;
          tempMarker = null;
          closeMemoryModal();

          if (savedTempMarker) { map.removeLayer(savedTempMarker); }

          var memories = res.mem ? [res.mem] : [];
          spotsData[res.spotId] = {
            spotData: res.spotData,
            memories: memories
          };

          var icon = createMemoryIcon(res.spotData.pinColor, memories.length);
          var marker = L.marker([res.spotData.lat, res.spotData.lng], { icon: icon }).addTo(map);
          marker.bindPopup(
            buildSpotPopupHtml(res.spotId, memories),
            { maxWidth: 350, minWidth: 290 }
          );
          marker.bindTooltip(buildSpotTooltipHtml(res.spotId, memories), {
            permanent: true, interactive: false, direction: 'top', offset: [0, -6], opacity: 1, className: 'spot-preview'
          });
          spotMarkerRefs[res.spotId] = marker;
          makeMarkerDraggable(marker, res.spotId);
          setupTooltipSuppression(marker);
          marker.openPopup();

          animateMarkerDrop(marker);
          showToast('ピンを保存しました', 'success');
          updateStats();
          console.log('新規スポット作成:', res.spotId);
        })
        .catch(function (err) {
          console.error('保存失敗:', err);
          showToast('保存に失敗しました。通信環境を確認してください', 'error');
        })
        .finally(function () { isSubmitting = false; });
    }

    // ===== 2. 追加フォームをモーダルで表示 =====
    if (t.id === 'btn-toggle-form') {
      e.preventDefault();
      if (!isWriteMode) return;
      openMemoryModal(
        buildAddMemoryFormHtml(),
        '<button class="submit-btn" id="btn-submit-add">思い出を残す</button>'
      );
    }

    // ===== 3. 既存スポットへ思い出を追加 =====
    if (t.id === 'btn-submit-add') {
      e.preventDefault();
      if (isSubmitting || !activeSpotId) return;

      var vals   = getFormValues();
      var spotId = activeSpotId;

      if (!vals.name && !vals.memory && !vals.photo) {
        showToast('お名前・思い出・写真のいずれかを入力してください', 'error');
        return;
      }

      isSubmitting  = true;
      t.disabled    = true;
      t.textContent = '保存中...';

      uploadPhoto(vals.photo)
        .then(function (photo) {
          return db.collection('spots').doc(spotId)
            .collection('memories').add({
              name: vals.name, memory: vals.memory, era: vals.era,
              photoURL: photo.photoURL, photoPath: photo.photoPath,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(function (memRef) {
              return {
                docId: memRef.id, name: vals.name, memory: vals.memory, era: vals.era,
                photoURL: photo.photoURL, photoPath: photo.photoPath,
                createdAt: new Date()
              };
            });
        })
        .then(function (newMem) {
          var entry = spotsData[spotId];
          if (!entry) return;

          entry.memories.push(newMem);

          // モーダルを閉じる
          closeMemoryModal();

          // ポップアップ内容・ツールチップとアイコンを再構築
          var marker = spotMarkerRefs[spotId];
          if (marker) {
            marker.setIcon(createMemoryIcon(entry.spotData.pinColor, entry.memories.length));
            marker.setPopupContent(buildSpotPopupHtml(spotId, entry.memories));
            marker.setTooltipContent(buildSpotTooltipHtml(spotId, entry.memories));
            marker.getPopup().update();
            marker.openPopup();
          }
          showToast('思い出を追加しました', 'success');
          updateStats();
          console.log('思い出を追加: spotId=' + spotId);
        })
        .catch(function (err) {
          console.error('追加失敗:', err);
          showToast('追加に失敗しました。通信環境を確認してください', 'error');
        })
        .finally(function () { isSubmitting = false; });
    }

    // ===== 4. 個別の思い出を削除 =====
    // ===== 思い出テキスト編集 =====
    if (t.classList.contains('edit-btn')) {
      e.preventDefault();
      if (!isWriteMode) return;
      var spotId   = t.getAttribute('data-spot-id');
      var memoryId = t.getAttribute('data-memory-id');
      if (!spotId || !memoryId) return;

      var entry = spotsData[spotId];
      if (!entry) return;
      var mem = null;
      for (var i = 0; i < entry.memories.length; i++) {
        if (entry.memories[i].docId === memoryId) { mem = entry.memories[i]; break; }
      }
      if (!mem) return;

      // memory-item 内をインライン編集フォームに差し替え
      var item = t.closest('.memory-item');
      if (!item) return;
      var currentText = mem.memory || '';
      item.innerHTML =
        '<div class="edit-inline">' +
          '<textarea id="edit-memory-text">' + escapeHtml(currentText) + '</textarea>' +
          '<div class="edit-inline-actions">' +
            '<button class="edit-save-btn" data-spot-id="' + escapeHtml(spotId) + '" data-memory-id="' + escapeHtml(memoryId) + '">保存</button>' +
            '<button class="edit-cancel-btn" data-spot-id="' + escapeHtml(spotId) + '">キャンセル</button>' +
          '</div>' +
        '</div>';
      var ta = document.getElementById('edit-memory-text');
      if (ta) { ta.focus(); }
      return;
    }

    if (t.classList.contains('edit-save-btn')) {
      e.preventDefault();
      var spotId   = t.getAttribute('data-spot-id');
      var memoryId = t.getAttribute('data-memory-id');
      var ta = document.getElementById('edit-memory-text');
      var newText = ta ? ta.value.trim() : '';
      if (!spotId || !memoryId || !newText) {
        if (!newText) showToast('思い出のテキストを入力してください', 'error');
        return;
      }

      var entry = spotsData[spotId];
      if (!entry) return;
      for (var i = 0; i < entry.memories.length; i++) {
        if (entry.memories[i].docId === memoryId) {
          entry.memories[i].memory = newText;
          break;
        }
      }

      var marker = spotMarkerRefs[spotId];
      if (marker) {
        marker.setPopupContent(buildSpotPopupHtml(spotId, entry.memories));
        marker.setTooltipContent(buildSpotTooltipHtml(spotId, entry.memories));
        marker.getPopup().update();
      }

      db.collection('spots').doc(spotId)
        .collection('memories').doc(memoryId)
        .update({ memory: newText })
        .then(function () { showToast('思い出を編集しました', 'success'); })
        .catch(function (err) {
          console.error('編集失敗:', err);
          showToast('編集に失敗しました', 'error');
        });
      return;
    }

    if (t.classList.contains('edit-cancel-btn')) {
      e.preventDefault();
      var spotId = t.getAttribute('data-spot-id');
      if (!spotId) return;
      var entry = spotsData[spotId];
      if (!entry) return;
      var marker = spotMarkerRefs[spotId];
      if (marker) {
        marker.setPopupContent(buildSpotPopupHtml(spotId, entry.memories));
        marker.getPopup().update();
      }
      return;
    }

    // ===== 写真だけ削除 =====
    if (t.classList.contains('photo-delete-btn')) {
      e.preventDefault();
      if (!isWriteMode) return;
      if (!confirm('この写真を削除しますか？')) return;

      var spotId    = t.getAttribute('data-spot-id');
      var memoryId  = t.getAttribute('data-memory-id');
      var photoPath = t.getAttribute('data-photo-path');
      if (!spotId || !memoryId) return;

      // Storage から写真を削除
      var p = (photoPath)
        ? storage.ref(photoPath).delete().catch(function (err) {
            console.warn('Storage写真の削除をスキップ:', err);
          })
        : Promise.resolve();

      // Firestore の photoURL, photoPath をクリア
      p.then(function () {
        return db.collection('spots').doc(spotId)
          .collection('memories').doc(memoryId)
          .update({ photoURL: '', photoPath: '' });
      }).then(function () {
        // ローカルデータを更新
        var entry = spotsData[spotId];
        if (!entry) return;
        for (var i = 0; i < entry.memories.length; i++) {
          if (entry.memories[i].docId === memoryId) {
            entry.memories[i].photoURL = '';
            entry.memories[i].photoPath = '';
            break;
          }
        }
        // ポップアップを再描画
        var marker = spotMarkerRefs[spotId];
        if (marker) {
          marker.setPopupContent(buildSpotPopupHtml(spotId, entry.memories));
          marker.setTooltipContent(buildSpotTooltipHtml(spotId, entry.memories));
          marker.getPopup().update();
        }
        showToast('写真を削除しました', 'info');
      }).catch(function (err) {
        console.error('写真削除失敗:', err);
        showToast('写真の削除に失敗しました', 'error');
      });
      return;
    }

    if (t.classList.contains('delete-btn')) {
      e.preventDefault();
      if (!isWriteMode) {
        showToast('削除するにはかきこむモードに切り替えてください', 'info');
        return;
      }
      if (!confirm('この思い出を削除しますか？')) return;

      var spotId    = t.getAttribute('data-spot-id');
      var memoryId  = t.getAttribute('data-memory-id');
      var photoPath = t.getAttribute('data-photo-path');

      var p = db.collection('spots').doc(spotId)
        .collection('memories').doc(memoryId).delete();

      if (photoPath) {
        p = p.then(function () {
          return storage.ref(photoPath).delete();
        }).catch(function (err) {
          console.warn('Storage写真の削除をスキップ:', err);
        });
      }

      p.then(function () {
        var entry = spotsData[spotId];
        if (!entry) return;

        // メモリ配列から除去
        entry.memories = entry.memories.filter(function (m) {
          return m.docId !== memoryId;
        });

        // ポップアップ・ツールチップとアイコンを更新
        var marker = spotMarkerRefs[spotId];
        if (marker) {
          marker.setIcon(createMemoryIcon(entry.spotData.pinColor, entry.memories.length));
          marker.setPopupContent(buildSpotPopupHtml(spotId, entry.memories));
          marker.setTooltipContent(buildSpotTooltipHtml(spotId, entry.memories));
          marker.getPopup().update();
        }
        showToast('思い出を削除しました', 'info');
        updateStats();
        console.log('思い出削除: ' + memoryId);
      })
      .catch(function (err) {
        console.error('削除失敗:', err);
        showToast('削除に失敗しました', 'error');
      });
    }

  });

  // ==================================================
  // パスワードフォームで Enter キー送信
  // ==================================================
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Enter' && e.target.id === 'input-auth-pw') {
      e.preventDefault();
      var btn = document.getElementById('btn-auth-submit');
      if (btn) btn.click();
    }
    if (e.key === 'Enter' && e.target.id === 'input-rename') {
      e.preventDefault();
      var btn = document.getElementById('btn-rename-save');
      if (btn) btn.click();
    }
  });

  // ==================================================
  // 写真プレビュー（ファイル選択時にサムネイル表示）
  // ==================================================
  document.addEventListener('change', function (e) {
    if (e.target.id !== 'input-photo') return;
    var preview = document.getElementById('photo-preview');
    if (!preview) return;

    var file = e.target.files && e.target.files[0];
    if (file && file.type.startsWith('image/')) {
      var reader = new FileReader();
      reader.onload = function (ev) {
        preview.src = ev.target.result;
        preview.classList.add('show');
      };
      reader.readAsDataURL(file);
    } else {
      preview.classList.remove('show');
      preview.src = '';
    }
  });

  // ==================================================
  // アルバム — 全思い出一覧表示
  // ==================================================
  var isAlbumMode = false;
  var albumMapFilter = 'old'; // 'old' | 'today'

  function renderAlbumCards(filterMapType) {
    var allMemories = [];
    Object.keys(spotsData).forEach(function (spotId) {
      var entry = spotsData[spotId];
      var mapType = entry.spotData.mapType || 'old';
      if (mapType !== filterMapType) return;
      entry.memories.forEach(function (m) {
        allMemories.push({
          spotId: spotId,
          placeName: entry.spotData.placeName,
          pinColor: entry.spotData.pinColor,
          name: m.name,
          era: m.era,
          memory: m.memory,
          photoURL: m.photoURL,
          createdAt: m.createdAt
        });
      });
    });

    // 新しい順にソート
    allMemories.sort(function (a, b) {
      var ta = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate().getTime() : new Date(a.createdAt).getTime()) : 0;
      var tb = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate().getTime() : new Date(b.createdAt).getTime()) : 0;
      return tb - ta;
    });

    var body = document.getElementById('album-body');
    var label = filterMapType === 'old' ? 'なつかし' : 'いま';
    if (allMemories.length === 0) {
      body.innerHTML = '<div class="album-empty">「' + label + '」の思い出はまだありません</div>';
    } else {
      var html = '';
      allMemories.forEach(function (m, idx) {
        var delay = Math.min(idx * 0.06, 1.5);
        html += '<div class="album-card" style="animation-delay:' + delay + 's;">';
        html += '<div class="album-card-place">';
        html += '<span class="color-dot" style="background:' + escapeHtml(m.pinColor || '#e8724a') + ';"></span>';
        html += escapeHtml(m.placeName || 'この場所');
        html += '</div>';
        if (m.name) {
          html += '<div class="album-card-name">' + escapeHtml(m.name) + ' さん</div>';
        }
        if (m.era) {
          html += '<div class="album-card-era">' + escapeHtml(m.era) + '</div>';
        }
        if (m.memory) {
          html += '<div class="album-card-memory">' + escapeHtml(m.memory) + '</div>';
        }
        if (m.photoURL) {
          html += '<img class="album-card-photo" src="' + escapeHtml(m.photoURL) + '" alt="写真">';
        }
        html += '<div class="album-card-date">' + escapeHtml(formatDate(m.createdAt)) + '</div>';
        html += '</div>';
      });
      body.innerHTML = html;
    }
  }

  function openAlbum() {
    if (isAlbumMode) return;
    isAlbumMode = true;

    // 現在のマップタイプに合わせてトグルの初期状態をセット
    albumMapFilter = currentMapType;
    var btns = document.querySelectorAll('.album-toggle-btn');
    btns.forEach(function (b) {
      b.classList.toggle('active', b.getAttribute('data-album-map') === albumMapFilter);
    });

    renderAlbumCards(albumMapFilter);

    document.getElementById('btn-album').classList.add('active');
    document.getElementById('app').classList.add('album-active');
    var overlay = document.getElementById('album-overlay');
    overlay.scrollTop = 0;
    overlay.classList.add('active');
  }

  function closeAlbum() {
    if (!isAlbumMode) return;
    isAlbumMode = false;

    document.getElementById('btn-album').classList.remove('active');
    document.getElementById('album-overlay').classList.remove('active');
    document.getElementById('app').classList.remove('album-active');
  }

  document.getElementById('btn-album').addEventListener('click', function () {
    if (isAlbumMode) {
      closeAlbum();
    } else {
      openAlbum();
    }
  });
  document.getElementById('album-close-btn').addEventListener('click', closeAlbum);

  // アルバム内の なつかし/いま トグル
  document.getElementById('album-toggle').addEventListener('click', function (e) {
    var btn = e.target.closest('.album-toggle-btn');
    if (!btn) return;
    var mapType = btn.getAttribute('data-album-map');
    if (mapType === albumMapFilter) return;

    albumMapFilter = mapType;
    var btns = document.querySelectorAll('.album-toggle-btn');
    btns.forEach(function (b) {
      b.classList.toggle('active', b.getAttribute('data-album-map') === mapType);
    });

    document.getElementById('album-overlay').scrollTop = 0;
    renderAlbumCards(mapType);
  });

  // ==================================================
  // 問い合わせパネル
  // ==================================================
  var contactToggle = document.getElementById('contact-toggle');
  var contactBody   = document.getElementById('contact-body');

  contactToggle.addEventListener('click', function () {
    contactBody.classList.toggle('open');
  });

  // パネル外クリックで閉じる
  document.addEventListener('click', function (e) {
    if (!document.getElementById('contact-panel').contains(e.target)) {
      contactBody.classList.remove('open');
    }
  });

  // 送信ボタン — Firestore の contacts コレクションに保存
  document.getElementById('contact-submit').addEventListener('click', function () {
    var nameEl    = document.getElementById('contact-name');
    var emailEl   = document.getElementById('contact-email');
    var messageEl = document.getElementById('contact-message');
    var name    = nameEl.value.trim();
    var email   = emailEl.value.trim();
    var message = messageEl.value.trim();

    if (!name) { showToast('お名前を入力してください', 'error'); return; }
    if (!email) { showToast('メールアドレスを入力してください', 'error'); return; }
    if (!message) { showToast('ききたいことを入力してください', 'error'); return; }

    // 送信中の二重押し防止
    var submitBtn = document.getElementById('contact-submit');
    submitBtn.disabled = true;
    submitBtn.textContent = '送信中...';

    db.collection('contacts').add({
      name: name,
      email: email,
      message: message,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(function () {
      nameEl.value = '';
      emailEl.value = '';
      messageEl.value = '';
      contactBody.classList.remove('open');
      showToast('お問い合わせを送信しました', 'success');
    }).catch(function (err) {
      console.error('問い合わせ送信失敗:', err);
      showToast('送信に失敗しました。もう一度お試しください', 'error');
    }).then(function () {
      submitBtn.disabled = false;
      submitBtn.textContent = '送信する';
    });
  });

</script>

</body>
</html>
